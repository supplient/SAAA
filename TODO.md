## v0.1.0
v0.1.0的目标是让各种功能都切实可用。

### v0.0.1

* [x] 通过直接点选资产来开始创建一条新的交易，自动将资产设为选中的资产
    * 编辑资产的功能则改为长按资产card后进入编辑
* [x] 当后台任务完成了刷新资产时弹出个提醒
* [x] Asset还应该新增一个"备注"项，用于方便用户给每类资产一个备注
* [x] 交易记录也需要一个和交易机会一样的"交易理由"，在将交易机会转换为交易记录时也直接继承
* [x] 数据库里为资产配置增加备注，不过还不需要UI
* [x] 交易费用目前先全部给一个5的默认值
* [x] 设置里允许关闭后台任务
* [x] 设置里的后台任务刷新时间改成下拉菜单的样式
* [x] 重置数据库的版本
* [x] 让当前库在github上实现自动build的系统，每次都会build一个release版本的apk出来


### v0.0.2
* [x] 实现交易机会检查算法
    * [x] 在资产配置中增加上一次可能买入机会的发生时间
    * [x] 从`CheckTradingOpportunitiesUseCase`拆分出子功能：
        * 不考虑日期和上一次可能的买入机会的时间，假设已经是可能的买入机会了，根据资产配置情况，算出买入机会的类
        * 专门根据日期和上一次可能的买入机会的时间，判断现在是否到了一次可能的买入机会的类
        * 专门根据资产配置情况计算卖出机会的类
    * [x] 完善检查当天是否为交易日的方法
        * 通过`AShare.kt`来实现
    * [x] 实现交易机会检查算法
    * [x] 暂时先禁用自动的交易机会检查
    * [x] 在交易机会列表界面增加按钮专门用于不考虑日期直接计算买入机会
    * [x] 调试交易机会检查算法
        * [x] 修正卖出机会
        * [x] 修正买入机会
        * [x] 算法检查过程最好有完整的思考过程展示出来方便我调试
* [x] 点选可用现金时应当弹出一个输入框，允许我输入新的可用现金值。输入框下部有两个按钮，左边是取消，右边是确认，默认值为当前可用现金。
* [x] 当资产单位价格刷新失败时，修改一下对应资产的样式，让用户知道哪些刷新失败了。
* [x] 不刷新货币基金和场外基金类型的资产，暂时只刷新股票类型的资产
* [x] 改进交易机会界面的显示，在每个交易机会上写上资产名称，交易份额，交易金额
* [x] 资产列表界面不需要标题"战略资产配置助手"，顶部全是按钮就行了
* [x] 在计算卖出买入机会时跳过场外基金，也就是只考虑股票类型的资产


### v0.0.3：重构资产列表界面
* 重构资产列表界面：
    * 顶部右侧的按钮移除“设置”按钮，只留下“交易记录”、“交易机会”、“刷新”
    * 顶部左侧的按钮不再是“API测试”，而改为唤出侧边栏
    * 侧边栏：
        * 侧边栏右上角为关闭侧边栏的按钮
        * 侧边栏主体为一个从上到下的按钮列表，依次为：
            * 配置备注：点开后跳转到编辑资产配置备注的界面
            * API测试：和原来的API测试按钮一样，跳转到API测试界面
            * 设置：和原来的设置按钮一样，跳转到设置界面
    * 在按钮行下方为资产配置总体信息栏：
        * 这是个可以展开/折叠的栏
        * 折叠后仅为短短的一行，仅显示数字，不显示文字：最左为“可用现金”，最右为“总资产”。
        * 展开后是每行一个条目：
            * 总资产
            * 可用现金
        * 注意展开后的效果是悬浮在资产列表主体上，而非把它整个往下挤压
    * 重构资产列表主体：
        * 从现在的卡片列表改为一个表格的样式
        * 为了适配竖屏显示：
            * 表格的第一列（资产名称）固定不动
            * 表格的剩余列可以横向滚动
            * 从而能在竖屏上实现表格信息的完整显示
        * 表格的每一列就是资产的一种信息
* 开发方案：
    * 界面结构调整(`AssetListScreen.kt`):
        * 在 `AssetListScreen` Composable 外层包裹 `Scaffold`，以支持侧边栏(`Navigation Drawer`)。
        * 创建一个新的 Composable `AppDrawer` 用于定义侧边栏内容。
    * 顶部应用栏(Top App Bar)修改(`AssetListScreen.kt`):
        * 修改 `TopAppBar` 的 `navigationIcon`，将其图标改为菜单图标，`onClick` 事件改为打开侧边栏(需要使用 `ScaffoldState` 中的 `drawerState.open()`)。
        * 从 `TopAppBar` 的 `actions` 中移除 `Settings` 按钮对应的 `IconButton`。
    * 侧边栏(Navigation Drawer)实现(建议新建 `AppDrawer.kt`):
        * 在 `AppDrawer` Composable 中，使用 `ModalDrawerSheet` 和 `NavigationDrawerItem` 来构建菜单项。
        * 菜单项包括：“配置备注”、“API测试”、“设置”。
        * 实现从侧边栏到各个界面的导航逻辑。这需要修改 `MainActivity.kt` 中的 `NavHost`，并为“配置备注”功能创建一个新的 `Screen` 和 `Composable`。
    * 资产配置总体信息栏(建议新建 `PortfolioSummary.kt`):
        * 创建新的 Composable `PortfolioSummaryCard`。
        * 使用 `remember { mutableStateOf(false) }` 来管理展开/折叠状态。
        * 使用 `AnimatedVisibility` 实现平滑的展开/折叠动画。
        * 折叠视图: 使用一个 `Row`，通过 `Arrangement.SpaceBetween` 将“可用现金”和“总资产”的数值分布在两端。
        * 展开视图: 使用 `Column` 展示“总资产”和“可用现金”的详细条目。
        * 为实现悬浮效果，可以将 `PortfolioSummaryCard` 放置在 `AssetListScreen` 的 `Box` 布局中，位于资产列表上方，通过 `Modifier.zIndex()` 控制层级。
        * 所需数据可直接从 `PortfolioViewModel` 的 `portfolioState` 中获取。
    * 资产列表表格化(建议新建 `AssetTable.kt`):
        * 创建 `AssetTable` Composable 来替代 `LazyColumn`。
        * 表头: 创建 `AssetTableHeader` Composable。它是一个 `Row`，首列固定，剩余列包裹在一个可水平滚动的 `Row` 中。
        * 数据行: 创建 `AssetTableRow` Composable。结构与表头类似，首列是资产名称（固定），剩余列是其他资产信息（可水平滚动）。
        * 滚动同步: 为了同步所有行的水平滚动，可以将 `scrollState` 提升到 `AssetTable` Composable 的级别，并将其同时传递给 `AssetTableHeader` 和每一个 `AssetTableRow`。
        * `AssetTable` 的主体是一个 `LazyColumn`，列表项是 `AssetTableRow`。
    * ViewModel 和导航(`PortfolioViewModel.kt`, `MainActivity.kt`):
        * `PortfolioViewModel` 目前的数据结构(`portfolioState` 和 `assetAnalyses`) 足以支持新界面，暂时无需大改。
        * 在应用的导航图(如 `MainActivity.kt` 内的 `NavHost`)中，为“配置备注”界面添加新路由。
        * 更新 `AssetListScreen` 的函数签名，以便接收和处理来自侧边栏的导航事件回调。

### v0.0.4: 局部优化使用体验

* [x] 资产列表里显示上次更新时间
* [x] 标题栏和表格之间有个空白带
* [x] 分行显示可用现金和总资产
* [x] 缩窄资产名称的列宽
* [x] 真机测试
* [x] 当所有资产合计占比不为100%时，要告知用户

### v0.0.5: 资产列表界面优化

* [x] 简化资产列表列显示：
    * [x] 移除"资产类型"列，改为在资产名称后拼接emoji（💰货币基金、🏦场外基金、📈股票）
    * [x] 合并"目标占比"、"当前占比"、"偏离度"为一列"占比"，显示为"当前占比=目标占比±偏离度"
    * [x] 合并"目标市值"、"当前市值"、"市值偏离"为一列"市值"，显示为"当前市值=目标市值±偏离市值"
    * [x] 新增"单价/份额"列，显示为"¥单价"和"×份额"两行
    * [x] 优化"更新时间"显示，分为"HH:mm:ss"和"yyyy-MM-dd"两行
* [x] 优化列宽设置：
    * [x] 缩窄各列宽度，提升界面紧凑性（资产名称80dp、占比80dp、市值100dp、单价份额70dp）
    * [x] 同步更新表头列宽，确保表头与内容列宽度一致
* [x] 禁用左滑手势：
    * [x] 在资产列表界面禁用左滑滑出侧边栏功能
    * [x] 避免与水平滑动资产列表时的误触
    * [x] 侧边栏只能通过点击菜单按钮打开


### v0.0.6: 资产列表界面全面优化

* [x] 增加隐藏资产数额的功能：市值、持有份额、总资产、可用现金
* [x] 增加资产排序功能
* [x] 资产种类改为只剩股票这一种，将货币基金与可用现金合并
* [x] 排序时增加偏差绝对值作为一种排序方案
    * [x] 新增"占比偏差绝对值"排序选项
    * [x] 新增"市值偏差绝对值"排序选项
    * [x] 实现基于绝对值的排序逻辑，确保-5%偏差排在3%偏差前面
* [x] 把"交易列表"按钮转移到侧边栏
    * [x] 从顶部操作栏移除交易列表按钮
    * [x] 在侧边栏中添加"交易列表"菜单项
    * [x] 更新相关导航逻辑
* [x] 资产占比总和里增加当前总占比的显示
    * [x] 显示格式：`Σ资产当前总占比=资产目标总占比-资产总占比偏差`
    * [x] 支持换行显示，与可用现金和总资产市值保持一致
* [x] 重新设计界面布局
    * [x] 将现金和占比信息从顶部栏移至底部固定显示
    * [x] 新增资产按钮移至顶部操作栏
    * [x] 移除FAB按钮，优化界面结构
* [x] 优化底部信息栏显示
    * [x] 一行显示：左侧可用现金，右侧资产占比信息
    * [x] 使用Surface组件提供视觉层次感
    * [x] 隐藏按钮不再控制底部信息栏显示
* [x] 修正资产当前占比计算
    * [x] 将可用现金纳入总资产计算
    * [x] 确保占比计算准确性：`资产当前占比=资产当前市值/(所有资产总市值+可用现金)`
    * [x] 修正目标市值计算逻辑
* [x] 完善编译环境搭建
    * [x] 安装配置Java 17环境
    * [x] 安装配置Android SDK环境
    * [x] 成功编译生成debug APK
    * [x] 记录完整的编译环境搭建文档


### v0.0.7：实现交易机会发现算法
* [x] 增加资产波动率
    * [x] `AShare.kt`增加计算波动率数据的接口`getVolatility`
        * 资产波动率系数$k$的计算：
            * 获取最近90个交易日的收盘价$p_1, p_2, \dots, p_{90}$，其中$p_1$为前一个交易日的收盘价
            * 计算89个每日收益率$\delta_i=\log\frac{p_i}{p_{i+1}}$
            * 计算每日收益率的标准差，即为每日波动率
            * 再计算年化波动率$k$ = 每日波动率 $\times \sqrt{252}$
                * 其中252为每年的交易天数，股市通常为预估为252天
        * 最近90个交易日的数据可以通过`getPrice(code, <昨天>, 90, "1d")`来获取
    * [x] 给Asset增加`volatility`项，存储最新的波动率数据
        * 每次刷新时，除了刷新unitValue，也刷新`volatility`
        * 正确实现database的migration
    * [x] 在AssetList里增加一列用于显示波动率
        * 显示在更新日期的左边一列
* [x] 给`AShare.kt`增加获取七日涨跌幅的接口
    * 七日涨跌幅$\delta$ = (当前市价 - 七个交易日前收盘价)/七个交易日前收盘价
* [x] 将七日涨跌幅也存入数据库中
* [x] 合并`AShare.kt`中的接口，使得一次http请求就能计算出当前市价、七日涨跌幅、90日年化波动率
* [x] 实现买入因子计算
    * 对资产计算：
      * 偏移因子$E$：
        $$
        E = \frac{r}{r + \tilde{r}}
        $$
        * 其中$r$为相对偏移值 = (目标占比 - 当前占比)/目标占比
        * $\tilde{r}$为半饱和相对偏移，表示资产占比正常会有的相对偏移
          * 目前给定为10%
      * 跌幅因子$D$：
        $$
        D = \frac{d}{d + \tilde{d}}
        $$
        * 其中$d$为七日绝对跌幅，由七日涨跌幅$\delta$计算得到：
          $$
          d = \max(0, -\delta)
          $$
          * 七日涨跌幅$\delta$ = (当前市价 - 七个交易日前收盘价)/七个交易日前收盘价
        * $\tilde{d}$为半饱和跌幅，表示一支股票正常可能有的七日跌幅
          * 目前给定为5%
    * 然后再计算买入因子$B$：
      $$
      B = (1-k)( \alpha E + (1-\alpha)D )
      $$
      * 其中$\alpha\in[0,1]$为给定的偏移权重
        * 目前给定为0.8
      * $k\in[0,1]$为资产波动率
    * 其中参数可以在`SettingsScreen`里修改，存入数据库中
        * 参数包括半饱和相对偏移、半饱和跌幅、偏移权重
    * 买入因子、偏移因子、跌幅因子都作为资产信息的一部分存入数据库中
    * 在资产列表中增加一列专门显示买入因子
* [x] 实现卖出阈值计算
    * 计算资产配置总体风险：
        $$
        f_i = k_i a_i \\
        f = \sum_i^n f_i
        $$
        * 其中$n$为超配资产数目，$i$为遍历每一种资产
        * $k_i$为资产年化波动率
        * $a_i$为该资产的超配偏移量 = max(0, 当前占比 - 目标占比)
    * 再根据总体风险计算总体风险因子：
        $$
        F = \frac{f}{f+\tilde{f}}
        $$
        * 其中$\tilde{f}$为半饱和总体风险，表示正常情况下总体会具有的风险
            * 目前给定为$10 \times 0.7\% \times 0.5\% = 0.00035$
    * 对每个超配资产计算其卖出阈值：
        * 基础卖出阈值$S$为给定的30%
        * 先对其根据波动率进行调整，波动率越高的资产，卖出阈值越紧：
        $$
        S \leftarrow (1-k) S
        $$
        * 再根据资产总体风险缩紧所有资产的卖出阈值：
        $$
        S \leftarrow (1-F) S
        $$
    * 其中基础卖出阈值$S$、半饱和总体风险$\tilde{f}$为给定参数，在`SettingsScreen`中修改，并存入数据库中
    * 算出的卖出阈值$S$作为资产信息的一部分存入数据库中
    * 将总体风险因子作为资产配置的一部分存入数据库中
    * 在资产列表中增加一列专门显示卖出阈值
    * 在刷新资产列表时一并更新卖出阈值
    * 在资产列表底部显示总体风险因子
* [x] 将买入因子和卖出阈值的计算过程可视化，便于调试
    * [x] 将中间计算过程存入asset中
        * [x] 建立一张另外的表，作为`AssetAnalysis`，和`Asset`区分开来
            * 将`volatility, sevenDayReturn, buyFactor, sellThreshold`转移到该表中
            * 移除`offsetFactor, drawdownFactor`
        * [x] 存入买入因子的中间计算过程到`AssetAnalysis`
            * 计算过程`buyFactorLog`为一个string
            * 其实质就是将计算过程编写成一个单行日志
            * 例如：`(<目标占比>-<当前占比>)/<目标占比>=<相对偏移>; <相对偏移>/(<相对偏移>+<半饱和相对偏移>=<偏移因子>; max(0, -<七日涨跌幅>)=<七日绝对跌幅>; <七日绝对跌幅>/(<七日绝对跌幅>+<半饱和跌幅>)=<跌幅因子>; <偏移权重>*<偏移因子>+<1-偏移权重>*<跌幅因子>=<去波动率的买入因子>; <1-资产波动率>*<去波动率的买入因子>=<买入因子>`
        * [x] 存入卖出阈值的中间计算过程到`AssetAnalysis`
            * `<基础卖出阈值>*<1-资产波动率>*<1-总体风险因子>=<卖出阈值>`
        * [x] 存入总体风险因子的中间计算过程到资产配置`Portfolio`中
            * `<第一个资产风险>+<第二个资产风险>+...<最后一个资产风险>=<资产总体风险>; <资产总体风险>/(<资产总体风险>+<半饱和总体风险>)=<总体风险因子>`
    * [x] 在`AddEditAssetScreen`的最下面增加对买入因子、卖出因子的计算过程的只读展示
        * 其中，原字符串里的"; "应当被替换为换行符
    * [x] 在`ConfigNoteScreen`的最下面增加对总体风险因子的计算过程的只读展示
* [x] 为什么现在导入数据以后没有波动率等数据计算出来？
    * 导入数据后assetAnalysis没有建立
    * 科创债、自由现金流交易日数不足90日
* [x] 优化计算过程日志，增加公式含义
* [x] 拆分刷新过程为asset刷新和assetAnalaysis刷新
* [x] 新增一个资产分析界面
    * 它类似于资产列表界面，不过显示内容不同
    * 它有如下列：
        * 和资产列表界面一样的：
            * 资产名称（和资产列表界面一样固定不动，其余列可滚动）
            * 占比
            * 波动率
            * 买入因子
            * 卖出阈值
        * 新增的：
            * 七日涨跌幅：显示在波动率的左边
    * 该界面中右上角也有个刷新按钮，但它不刷新asset，而仅仅只刷新assetAnalysis
        * 也就是仅调用`updateAssetAnalyses`
    * 该界面右上角也有排序按钮，逻辑和资产列表界面的相同
    * 该界面通过资产列表界面的侧边栏里的“资产分析”按钮进入
* [x] Settings界面里修改参数没有效果
* [x] 往assetAnalaysis增加中间计算结果
    * [x] 增加中间计算结果到assetAnalysis中：
        * 计算买入因子时的：
            * 相对偏移
            * 偏移因子
            * 跌幅因子
            * 去波动买入因子
        * 计算卖出阈值时的：
            * 资产风险
        * 注意要正确更新数据库
    * [x] 将新增项显示到资产分析界面


### v0.0.8: 优化UI
* [x] 优化资产列表界面
    * [x] 将“波动率”列合并进“单价/份额”列
        * 合并后列名称为“价份波”
        * 波动率显示为“〰️...%”
    * [x] 显示卖出阈值时将其从相对阈值转换为绝对阈值
        * `AssetAnalysis`中存储的是相对阈值，也就是说该类资产超出目标占比不能超过目标占比的百分之几
            * 即(当前占比-目标占比)/目标占比 < 卖出的相对阈值
        * 我现在希望能将它转化为一个绝对阈值，也就是显示`卖出的相对阈值 * 目标占比`后的结果
    * [x] 将买入因子和卖出阈值合并为一列
        * 合并后列名称为“买因卖阈”
        * 两者使用不一样的颜色
        * 买入因子显示为“🏷️...”（不用转换为百分号显示，不过可以保持现在的放大一百倍后显示）
        * 卖出阈值显示为“+...%卖”
    * [x] 修改列顺序
    * [x] 重构AssetTable中的代码，让表头和列内容能用一个代码块，避免过于分散
    * [x] 将`PortfolioViewModel.AssetAnalysis`重命名为`PortfolioViewModel.AssetInfo`
* [x] 优化资产分析列表界面
    * [x] 与资产列表界面共用代码
    * [x] 在不同列之间，让相同数据共用相同的显示格式
    * [x] 资产分析列表中也使用组合列
* [x] 根据我的手机显示效果修改各列宽度
* [x] 修复隐藏资产数值显示
    * [x] 不隐藏资产单价
    * [x] 隐藏可用现金


### v0.0.9: 优化交易记录
* [x] 禁止从交易列表界面创建交易记录
    * 直接删除交易列表界面里的FAB
* [x] 重写`AddEditTransactionScreen`
    * 标题下面一行小字写资产名称
    * 页面上部是两行交易前后的资产情况，有如下列：
        * 占比列
        * 市值列
    * 页面中部：
        * 第一行是两个控件：
            * 左边是小小一个单选框，用于选择交易类型“买/卖”
            * 右边是交易份额
        * 第二行也是两个控件：
            * 左边是资产单价，直接和存在数据库里的资产单价关联起来，不可修改
            * 右边是个小小的刷新按钮，点击的话就会调用方法来更新**这一个**资产的单价
        * 第三行也是两个控件：
            * 左边是一个比较小（大概占20%宽度）的“手续费”输入框
            * 右边是一个比较大的“总额”，它等于“份额*单价+手续费”，不可修改
        * 第四行是交易理由
    * 页面下部保持现状，还是取消和保存这两个按钮
* [ ] 优化可用现金编辑
    * 分成两个页面
    * 短按可用现金是弹出“可用现金快捷编辑框”
    * 长按可用现金是弹出现在的“可用现金编辑框”
* [ ] 优化交易记录编辑界面的操作
    * [x] 在份额处添加两个向上向下的小按钮，点一下就是一手
* [ ] 重写交易记录列表界面






# 后续再做
* [ ] `getMarketStats`里的获取方式会不会获取不到当前价格？以及波动率计算是不是应该有不含今天的前90天？
* [ ] 考虑更改波动率计算方法，改为`Yang-Zhang optimal volatility estimator`
    * 它能够把前一天的收盘价到第二天的开盘价之间的价格波动也考虑进来，还有根据最高、最低估算出的日内波动率也考虑进来
* [ ] 横屏以后真机上在导航栏和app主体之间有个空白带
* [ ] 可调节表头
* [ ] 后台任务似乎依然无效，再研究研究
    * 记得调试完后台任务以后还要处理交易机会发现的通知
    * 发现可能只是avd无效？试试实机调试
* [ ] notification无效？
* [ ] 在编辑交易时，增加一个按钮，按下后会根据输入的份额和当前净值、交易费用自动计算交易金额
    * 注意交易金额实质上就等于现金变化量
* [ ] 把买入机会的检查从后台任务里独立出来，专门做成一个每天两点进行的alarm
* [ ] 交易机会界面显示卖出份额和总金额，最好再显示一下各项数值的前后变化
* [ ] 优化交易机会发现
    * [ ] 编写单元测试
    * [ ] 修正买入机会窗口判断
* [ ] 自动备份数据到云端
* [ ] 从数据库里删除股票
* [ ] 横屏的时候太挤了
* [ ] 修改排序方法，直接通过点击表头来排序