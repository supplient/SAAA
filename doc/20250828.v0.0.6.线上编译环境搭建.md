# 线上编译环境搭建

**日期**: 2025-08-28  
**版本**: v0.0.6  
**文档类型**: 编译环境配置指南

## 概述

本文档记录了在Linux服务器上搭建Android应用编译环境的完整过程，包括Java 17和Android SDK的安装配置。

## 环境要求

- **操作系统**: Ubuntu Linux 6.12.8+
- **Java版本**: OpenJDK 17
- **Android SDK**: 最新版本
- **Gradle**: 8.13

## 安装步骤

### 1. 安装Java 17

```bash
# 更新包管理器
sudo apt update

# 安装OpenJDK 17
sudo apt install -y openjdk-17-jdk

# 验证安装
java -version
```

**预期输出**:
```
openjdk version "17.0.16" 2025-07-15
OpenJDK Runtime Environment (build 17.0.16+8-Ubuntu-0ubuntu125.04.1)
OpenJDK 64-Bit Server VM (build 17.0.16+8-Ubuntu-0ubuntu125.04.1, mixed mode, sharing)
```

### 2. 设置Java环境变量

```bash
# 设置JAVA_HOME
export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64

# 更新PATH
export PATH=$JAVA_HOME/bin:$PATH

# 验证环境变量
echo "JAVA_HOME: $JAVA_HOME"
java -version
```

### 3. 下载Android SDK命令行工具

```bash
# 切换到用户目录
cd ~

# 下载Android SDK命令行工具
wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip

# 创建Android SDK目录
mkdir -p ~/Android/Sdk

# 解压到SDK目录
cd ~/Android/Sdk
unzip ~/commandlinetools-linux-11076708_latest.zip
```

### 4. 配置Android SDK目录结构

```bash
# 重命名目录以符合标准结构
mv cmdline-tools latest
mkdir cmdline-tools
mv latest cmdline-tools/

# 设置Android SDK环境变量
export ANDROID_HOME=~/Android/Sdk
export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools

# 验证SDK管理器可用性
sdkmanager --version
```

### 5. 安装Android SDK组件

```bash
# 接受所有许可证
yes | sdkmanager --licenses

# 安装必要的SDK组件
sdkmanager "platform-tools" "build-tools;36.0.0" "platforms;android-36"
```

**安装的组件**:
- `platform-tools`: Android平台工具
- `build-tools;36.0.0`: 构建工具版本36.0.0
- `platforms;android-36`: Android 36 API平台

### 6. 设置完整环境变量

```bash
# 设置完整的环境变量
export ANDROID_HOME=~/Android/Sdk
export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
export PATH=$JAVA_HOME/bin:$PATH

# 验证环境配置
echo "ANDROID_HOME: $ANDROID_HOME"
echo "JAVA_HOME: $JAVA_HOME"
java -version
```

## 验证编译环境

### 1. 进入项目目录

```bash
cd /workspace/StrategicAssetAllocationAssistant
```

### 2. 验证Gradle可用性

```bash
./gradlew --version
```

### 3. 编译Debug APK

```bash
./gradlew :app:assembleDebug
```

**成功标志**:
- 编译过程无错误
- 生成APK文件: `app/build/outputs/apk/debug/app-debug.apk`
- APK大小约59MB

## 环境变量持久化

为了确保环境变量在重启后仍然有效，建议将以下内容添加到 `~/.bashrc` 文件：

```bash
# Android SDK环境变量
export ANDROID_HOME=~/Android/Sdk
export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools

# Java环境变量
export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
export PATH=$JAVA_HOME/bin:$PATH
```

然后执行：
```bash
source ~/.bashrc
```

## 常见问题解决

### 1. SDK管理器命令未找到

**问题**: `sdkmanager: command not found`

**解决方案**: 检查目录结构是否正确，确保 `cmdline-tools/latest/bin/` 在PATH中

### 2. Java版本不匹配

**问题**: 项目需要Java 17，但系统只有Java 21

**解决方案**: 安装OpenJDK 17并正确设置JAVA_HOME

### 3. 许可证接受失败

**问题**: SDK组件安装时许可证接受失败

**解决方案**: 使用 `yes | sdkmanager --licenses` 自动接受所有许可证

## 与GitHub Actions的对比

本环境配置与项目中的 `.github/workflows/android-release.yml` 保持一致：

- **Java版本**: 17 (GitHub Actions使用 `actions/setup-java@v4` 设置Java 17)
- **Android SDK**: 最新版本命令行工具
- **构建工具**: 支持compileSdk 36

## 总结

通过以上步骤，成功搭建了完整的Android应用编译环境：

✅ Java 17 环境配置完成  
✅ Android SDK 安装配置完成  
✅ 环境变量设置完成  
✅ 编译测试通过  
✅ 生成Debug APK成功  

该环境可以支持项目的日常开发和构建需求，与CI/CD流程保持一致。