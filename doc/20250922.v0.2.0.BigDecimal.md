# BigDecimalæ”¹é€ å¼€å‘è®¡åˆ’ v0.1.1

## æ¦‚è¿°

ä¸ºäº†è§£å†³æµ®ç‚¹è¿ç®—ç²¾åº¦é—®é¢˜ï¼Œå°†ç†è´¢APPä¸­æ‰€æœ‰æ¶‰åŠé‡‘é’±ã€ä»·æ ¼ã€é‡‘é¢çš„Doubleç±»å‹å­—æ®µæ”¹ä¸ºBigDecimalç±»å‹ã€‚æ­¤æ”¹é€ æ¶‰åŠæ•°æ®åº“å±‚ã€ä¸šåŠ¡é€»è¾‘å±‚ã€UIå±‚çš„å…¨é¢ä¿®æ”¹ã€‚

## æ”¹é€ èŒƒå›´åˆ†æ

### 1. æ•°æ®åº“å®ä½“ç±» (Database Entities)

#### AssetEntity.kt
- `shares: Double?` â†’ `shares: BigDecimal?` (ä»½é¢)
- `unitValue: Double?` â†’ `unitValue: BigDecimal?` (å•ä½ä»·å€¼/å‡€å€¼)
- `targetWeight: Double` ä¿æŒä¸å˜ (ç›®æ ‡å æ¯”æ˜¯æ¯”ä¾‹ï¼Œä¸æ¶‰åŠå…·ä½“é‡‘é¢)

#### TransactionEntity.kt
- `shares: Double` â†’ `shares: BigDecimal` (ä»½é¢)
- `price: Double` â†’ `price: BigDecimal` (ä»·æ ¼)
- `fee: Double` â†’ `fee: BigDecimal` (æ‰‹ç»­è´¹)  
- `amount: Double` â†’ `amount: BigDecimal` (é‡‘é¢)

#### PortfolioEntity.kt
- `cash: Double` â†’ `cash: BigDecimal` (ç°é‡‘)
- `overallRiskFactor: Double?` ä¿æŒä¸å˜ (é£é™©å› å­æ˜¯è®¡ç®—ç³»æ•°)

### 2. åŸŸæ¨¡å‹ (Domain Models)

#### Domain.kt - Assetæ¨¡å‹
- `shares: Double?` â†’ `shares: BigDecimal?`
- `unitValue: Double?` â†’ `unitValue: BigDecimal?`
- `currentMarketValue: Double` â†’ `currentMarketValue: BigDecimal` (è®¡ç®—å±æ€§)
- `targetWeight: Double` ä¿æŒä¸å˜ (æ¯”ä¾‹)

#### Portfolioæ¨¡å‹
- `cash: Double` â†’ `cash: BigDecimal`

#### Transactionæ¨¡å‹
- `shares: Double` â†’ `shares: BigDecimal`
- `price: Double` â†’ `price: BigDecimal`
- `fee: Double` â†’ `fee: BigDecimal`
- `amount: Double` â†’ `amount: BigDecimal`

#### TradingOpportunityæ¨¡å‹
- `shares: Double` â†’ `shares: BigDecimal`
- `price: Double` â†’ `price: BigDecimal`
- `fee: Double` â†’ `fee: BigDecimal`
- `amount: Double` â†’ `amount: BigDecimal`

#### AssetAnalysisæ¨¡å‹
- åˆ†æå­—æ®µï¼ˆå¦‚`volatility`, `sevenDayReturn`, `buyFactor`ç­‰ï¼‰ä¿æŒDouble (ç»Ÿè®¡/è®¡ç®—ç³»æ•°)

### 3. ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic)

#### éœ€è¦ä¿®æ”¹çš„è®¡ç®—ç±»ï¼š
- **BuyOpportunityCalculator.kt**: æ€»èµ„äº§è®¡ç®—ã€é‡‘é¢ç›¸å…³å¸¸é‡ã€äº¤æ˜“è®¡ç®—é€»è¾‘
- **SellOpportunityCalculator.kt**: æ€»èµ„äº§å’Œäº¤æ˜“è®¡ç®—é€»è¾‘
- **PortfolioRepository.kt**: `addTransaction()`æ–¹æ³•ä¸­çš„ç°é‡‘å’Œä»½é¢æ›´æ–°
- **AssetInfoCalc.kt**: `buildAssetInfo()`å‡½æ•°ä¸­çš„å¸‚å€¼ã€ç›®æ ‡ä»·å€¼ã€åå·®è®¡ç®—
- **å„ç§è®¡ç®—å™¨ç±»**: æ¶‰åŠä»·æ ¼å’Œé‡‘é¢çš„è®¡ç®—éƒ¨åˆ†

#### å¸¸é‡æ”¹é€ ï¼š
```kotlin
// æ”¹é€ å‰
private val handSize = 100.0
private val minAbsoluteAmount = 1000.0  
private val defaultFee = 5.0

// æ”¹é€ å
private val handSize = BigDecimal("100")
private val minAbsoluteAmount = BigDecimal("1000")
private val defaultFee = BigDecimal("5")
```

### 4. UIå±‚ (Presentation Layer)

#### AssetInfoæ¨¡å‹
- `marketValue: Double` â†’ `marketValue: BigDecimal`
- `targetMarketValue: Double` â†’ `targetMarketValue: BigDecimal`
- `deviationValue: Double` â†’ `deviationValue: BigDecimal`

#### UIç»„ä»¶ä¿®æ”¹ï¼š
- **AssetMetricsCells.kt**: æ‰€æœ‰è´§å¸å’Œä»½é¢æ ¼å¼åŒ–é€»è¾‘
- **å„ç§ViewModel**: æ€»èµ„äº§è®¡ç®—ã€ç™¾åˆ†æ¯”è®¡ç®—ã€ç”¨æˆ·è¾“å…¥éªŒè¯
- **è¾“å…¥ç»„ä»¶**: æ•°æ®éªŒè¯å’Œè½¬æ¢é€»è¾‘

#### æ ¼å¼åŒ–æ”¹é€ ï¼š
```kotlin
// æ”¹é€ å‰
String.format("%.2f", amount)

// æ”¹é€ å  
amount.setScale(2, RoundingMode.HALF_UP).toString()
```

### 5. åºåˆ—åŒ–æ”¯æŒ

#### éœ€è¦æ·»åŠ çš„ç»„ä»¶ï¼š
1. **BigDecimalSerializer**: è‡ªå®šä¹‰åºåˆ—åŒ–å™¨
2. **Roomç±»å‹è½¬æ¢å™¨**: BigDecimal â†” String
3. **JSONåºåˆ—åŒ–**: åœ¨serializationModuleä¸­æ³¨å†ŒBigDecimalåºåˆ—åŒ–å™¨

#### ç¤ºä¾‹å®ç°ï¼š
```kotlin
// BigDecimalåºåˆ—åŒ–å™¨
@Serializer(forClass = BigDecimal::class)
object BigDecimalSerializer : KSerializer<BigDecimal> {
    override val descriptor = PrimitiveSerialDescriptor("BigDecimal", PrimitiveKind.STRING)
    override fun serialize(encoder: Encoder, value: BigDecimal) = encoder.encodeString(value.toString())
    override fun deserialize(decoder: Decoder): BigDecimal = BigDecimal(decoder.decodeString())
}

// Roomè½¬æ¢å™¨
@TypeConverter
fun bigDecimalToString(bigDecimal: BigDecimal?): String? = bigDecimal?.toString()

@TypeConverter  
fun stringToBigDecimal(string: String?): BigDecimal? = string?.let { BigDecimal(it) }
```

## æ¸è¿›å¼å®æ–½è®¡åˆ’ (ç¡®ä¿æ¯æ­¥å¯ç¼–è¯‘)

### æ­¥éª¤1: åŸºç¡€è®¾æ–½å‡†å¤‡ (1-2å¤©)
**ç›®æ ‡**: æ·»åŠ BigDecimalæ”¯æŒåŸºç¡€è®¾æ–½ï¼Œä¸å½±å“ç°æœ‰ä»£ç 
1. åˆ›å»º`MoneyUtils`å·¥å…·ç±»
2. æ·»åŠ BigDecimalåºåˆ—åŒ–å™¨
3. åˆ›å»ºRoomç±»å‹è½¬æ¢å™¨ (ä¸ç«‹å³ä½¿ç”¨)
4. æ·»åŠ BigDecimalæ‰©å±•å‡½æ•°
**éªŒè¯**: ç¼–è¯‘é€šè¿‡ï¼Œç°æœ‰åŠŸèƒ½æ­£å¸¸

### æ­¥éª¤2: æ•°æ®åº“åŒå­—æ®µè¿‡æ¸¡ (2-3å¤©)
**ç›®æ ‡**: åœ¨Entityä¸­æ·»åŠ BigDecimalå­—æ®µï¼Œä¿ç•™åŸDoubleå­—æ®µ
1. ç»™AssetEntityæ·»åŠ `sharesDecimal`ã€`unitValueDecimal`å­—æ®µ
2. ç»™TransactionEntityæ·»åŠ `sharesDecimal`ã€`priceDecimal`ã€`feeDecimal`ã€`amountDecimal`å­—æ®µ  
3. ç»™PortfolioEntityæ·»åŠ `cashDecimal`å­—æ®µ
4. åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬ (æ·»åŠ æ–°åˆ—)
5. æ·»åŠ åŒæ­¥é€»è¾‘ (Double â†” BigDecimal)
**éªŒè¯**: ç¼–è¯‘é€šè¿‡ï¼Œæ•°æ®åº“è¿ç§»æˆåŠŸï¼Œæ•°æ®åŒæ­¥æ­£å¸¸

### æ­¥éª¤3: åŸŸæ¨¡å‹åŒå­—æ®µè¿‡æ¸¡ (2-3å¤©)
**ç›®æ ‡**: åœ¨Domain modelsä¸­æ·»åŠ BigDecimalå­—æ®µï¼Œä¿ç•™åŸå­—æ®µ
1. ç»™Assetæ·»åŠ `sharesDecimal`ã€`unitValueDecimal`ã€`currentMarketValueDecimal`å±æ€§
2. ç»™Portfolioæ·»åŠ `cashDecimal`å±æ€§
3. ç»™Transaction/TradingOpportunityæ·»åŠ BigDecimalå­—æ®µ
4. æ·»åŠ Entity â†” Domainè½¬æ¢æ—¶çš„åŒå‘åŒæ­¥
**éªŒè¯**: ç¼–è¯‘é€šè¿‡ï¼Œæ•°æ®è½¬æ¢æ­£ç¡®

### æ­¥éª¤4: è®¡ç®—ç±»é€‚é…å±‚ (3-4å¤©)
**ç›®æ ‡**: åœ¨è®¡ç®—ç±»ä¸­æ·»åŠ BigDecimalç‰ˆæœ¬çš„æ–¹æ³•ï¼Œä¿ç•™åŸæ–¹æ³•
1. BuyOpportunityCalculatoræ·»åŠ `calculateWithDecimal()`æ–¹æ³•
2. SellOpportunityCalculatoræ·»åŠ `calculateWithDecimal()`æ–¹æ³•
3. AssetInfoCalcæ·»åŠ `buildAssetInfoWithDecimal()`æ–¹æ³•
4. å„ç§Calculatorç±»æ·»åŠ BigDecimalç‰ˆæœ¬
5. å¸¸é‡è½¬ä¸ºBigDecimalç‰ˆæœ¬
**éªŒè¯**: ç¼–è¯‘é€šè¿‡ï¼Œæ–°æ—§æ–¹æ³•ç»“æœä¸€è‡´

### æ­¥éª¤5: UIæ¨¡å‹åŒå­—æ®µè¿‡æ¸¡ (2-3å¤©)
**ç›®æ ‡**: UIæ¨¡å‹æ”¯æŒBigDecimalï¼Œä¿ç•™Doubleå­—æ®µå…¼å®¹æ€§
1. AssetInfoæ·»åŠ BigDecimalå­—æ®µç‰ˆæœ¬
2. ViewModelæ·»åŠ BigDecimalè®¡ç®—æ–¹æ³•
3. æ·»åŠ æ ¼å¼åŒ–å·¥å…·æ”¯æŒBigDecimal
**éªŒè¯**: ç¼–è¯‘é€šè¿‡ï¼ŒUIæ˜¾ç¤ºæ­£å¸¸

### æ­¥éª¤6: é€æ­¥åˆ‡æ¢ä¸šåŠ¡é€»è¾‘ (3-4å¤©)
**ç›®æ ‡**: é€ä¸ªä¸šåŠ¡åŠŸèƒ½åˆ‡æ¢åˆ°BigDecimalç‰ˆæœ¬
1. äº¤æ˜“æ·»åŠ /ç¼–è¾‘åŠŸèƒ½åˆ‡æ¢
2. èµ„äº§ç®¡ç†åŠŸèƒ½åˆ‡æ¢  
3. æŠ•èµ„ç»„åˆè®¡ç®—åˆ‡æ¢
4. æœºä¼šè®¡ç®—åˆ‡æ¢
**éªŒè¯**: æ¯åˆ‡æ¢ä¸€ä¸ªåŠŸèƒ½åç¼–è¯‘é€šè¿‡ï¼ŒåŠŸèƒ½æµ‹è¯•æ­£å¸¸

### æ­¥éª¤7: UIå±‚åˆ‡æ¢ (2-3å¤©)
**ç›®æ ‡**: UIå±‚å®Œå…¨åˆ‡æ¢åˆ°BigDecimalæ˜¾ç¤º
1. æ‰€æœ‰é‡‘é¢æ˜¾ç¤ºåˆ‡æ¢åˆ°BigDecimalæ ¼å¼åŒ–
2. ç”¨æˆ·è¾“å…¥éªŒè¯åˆ‡æ¢åˆ°BigDecimal
3. å›¾è¡¨å’Œç»Ÿè®¡æ˜¾ç¤ºé€‚é…BigDecimal
**éªŒè¯**: ç¼–è¯‘é€šè¿‡ï¼ŒUIæ˜¾ç¤ºç²¾ç¡®æ— è¯¯

### æ­¥éª¤8: æ¸…ç†Doubleå­—æ®µ (1-2å¤©)
**ç›®æ ‡**: ç§»é™¤å·²ä¸ä½¿ç”¨çš„Doubleå­—æ®µå’Œæ–¹æ³•
1. ç§»é™¤Entityä¸­çš„Doubleå­—æ®µ
2. ç§»é™¤Domainæ¨¡å‹ä¸­çš„Doubleå­—æ®µ  
3. ç§»é™¤è®¡ç®—ç±»ä¸­çš„Doubleç‰ˆæœ¬æ–¹æ³•
4. ç§»é™¤UIæ¨¡å‹ä¸­çš„Doubleå­—æ®µ
5. æ•°æ®åº“è¿ç§»è„šæœ¬åˆ é™¤æ—§åˆ—
**éªŒè¯**: ç¼–è¯‘é€šè¿‡ï¼Œæ‰€æœ‰åŠŸèƒ½æ­£å¸¸ï¼Œæ— é—ç•™Doubleå­—æ®µ

### æ­¥éª¤9: ä¼˜åŒ–å’Œæµ‹è¯• (2-3å¤©)
**ç›®æ ‡**: æ€§èƒ½ä¼˜åŒ–å’Œå…¨é¢æµ‹è¯•
1. æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
2. å•å…ƒæµ‹è¯•è¡¥å…¨
3. é›†æˆæµ‹è¯•
4. ç”¨æˆ·éªŒæ”¶æµ‹è¯•
**éªŒè¯**: æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œæ€§èƒ½æ»¡è¶³è¦æ±‚

## æŠ€æœ¯è€ƒè™‘äº‹é¡¹

### ç²¾åº¦è®¾ç½®
- **é‡‘é¢å­—æ®µ**: 4ä½å°æ•°ç²¾åº¦ (æ”¯æŒåˆ°åˆ†å˜)
- **ä»½é¢å­—æ®µ**: 6ä½å°æ•°ç²¾åº¦ (æ”¯æŒæ›´ç²¾ç¡®çš„ä»½é¢)
- **ä»·æ ¼å­—æ®µ**: 4ä½å°æ•°ç²¾åº¦
- **èˆå…¥æ¨¡å¼**: `RoundingMode.HALF_UP` (å››èˆäº”å…¥)

### æ€§èƒ½è€ƒè™‘
- BigDecimalæ¯”Doubleè®¡ç®—å¼€é”€æ›´å¤§ï¼Œå…³é”®è·¯å¾„éœ€è¦æ€§èƒ½æµ‹è¯•
- è€ƒè™‘åœ¨æ˜¾ç¤ºå±‚è¿›è¡Œç¼“å­˜
- æ‰¹é‡è®¡ç®—æ—¶ä½¿ç”¨MathContextä¼˜åŒ–

### å…¼å®¹æ€§
- æ•°æ®åº“è¿ç§»ç­–ç•¥: ä¿ç•™åŸå­—æ®µï¼Œæ–°å¢BigDecimalå­—æ®µï¼Œé€æ­¥è¿ç§»
- APIå…¼å®¹: è€ƒè™‘ä¿ç•™Doubleç±»å‹çš„getteræ–¹æ³•ä½œä¸ºè¿‡æ¸¡
- å‘åå…¼å®¹: æ”¯æŒä»æ—§ç‰ˆæœ¬æ•°æ®çš„å¹³æ»‘å‡çº§

### å·¥å…·ç±»è®¾è®¡
```kotlin
object MoneyUtils {
    val MONEY_SCALE = 4
    val SHARE_SCALE = 6  
    val MONEY_CONTEXT = MathContext(10, RoundingMode.HALF_UP)
    
    fun BigDecimal.toMoneyString(): String = 
        this.setScale(MONEY_SCALE, RoundingMode.HALF_UP).toString()
        
    fun String.toMoney(): BigDecimal = BigDecimal(this).setScale(MONEY_SCALE, RoundingMode.HALF_UP)
}
```

## é£é™©è¯„ä¼°

### é«˜é£é™©
- æ•°æ®åº“è¿ç§»å¤±è´¥å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±
- è®¡ç®—é€»è¾‘é”™è¯¯å¯èƒ½å½±å“æŠ•èµ„å†³ç­–
- æ€§èƒ½ä¸‹é™å¯èƒ½å½±å“ç”¨æˆ·ä½“éªŒ

### ä¸­é£é™©  
- UIæ˜¾ç¤ºæ ¼å¼ä¸ä¸€è‡´
- åºåˆ—åŒ–/ååºåˆ—åŒ–é”™è¯¯
- ä¸ç¬¬ä¸‰æ–¹APIçš„æ•°æ®ç±»å‹ä¸åŒ¹é…

### ä½é£é™©
- å•å…ƒæµ‹è¯•è¦†ç›–ä¸è¶³
- ä»£ç å¯è¯»æ€§ä¸‹é™
- å¼€å‘æ•ˆç‡ä¸´æ—¶ä¸‹é™

## éªŒæ”¶æ ‡å‡†

1. æ‰€æœ‰é‡‘é’±ç›¸å…³è®¡ç®—ç»“æœç²¾ç¡®æ— è¯¯
2. æ•°æ®åº“è¯»å†™æ­£å¸¸ï¼Œæ— æ•°æ®ä¸¢å¤±
3. UIæ˜¾ç¤ºæ ¼å¼ç»Ÿä¸€ç¾è§‚
4. æ€§èƒ½æ— æ˜æ˜¾ä¸‹é™
5. å•å…ƒæµ‹è¯•è¦†ç›–ç‡90%ä»¥ä¸Š
6. ä¸ç°æœ‰åŠŸèƒ½å®Œå…¨å…¼å®¹

## æ—¶é—´ä¼°ç®—

- **æ­¥éª¤1**: 1-2å¤© (åŸºç¡€è®¾æ–½å‡†å¤‡)
- **æ­¥éª¤2**: 2-3å¤© (æ•°æ®åº“åŒå­—æ®µè¿‡æ¸¡)  
- **æ­¥éª¤3**: 2-3å¤© (åŸŸæ¨¡å‹åŒå­—æ®µè¿‡æ¸¡)
- **æ­¥éª¤4**: 3-4å¤© (è®¡ç®—ç±»é€‚é…å±‚)
- **æ­¥éª¤5**: 2-3å¤© (UIæ¨¡å‹åŒå­—æ®µè¿‡æ¸¡)
- **æ­¥éª¤6**: 3-4å¤© (é€æ­¥åˆ‡æ¢ä¸šåŠ¡é€»è¾‘)
- **æ­¥éª¤7**: 2-3å¤© (UIå±‚åˆ‡æ¢)
- **æ­¥éª¤8**: 1-2å¤© (æ¸…ç†Doubleå­—æ®µ)
- **æ­¥éª¤9**: 2-3å¤© (ä¼˜åŒ–å’Œæµ‹è¯•)

**æ€»è®¡**: 18-27å¤© (çº¦3.5-5.5å‘¨)

### æ¸è¿›å¼å®æ–½çš„ä¼˜åŠ¿
1. **æ¯æ­¥å¯ç¼–è¯‘**: é™ä½å¼€å‘é£é™©ï¼Œä¾¿äºè°ƒè¯•
2. **å¯éšæ—¶å›æ»š**: æ¯ä¸ªæ­¥éª¤éƒ½æ˜¯ç¨³å®šçŠ¶æ€
3. **å¹¶è¡Œå¼€å‘å‹å¥½**: ä¸ä¼šé˜»å¡å…¶ä»–åŠŸèƒ½å¼€å‘
4. **æµ‹è¯•å‹å¥½**: å¯ä»¥é€æ­¥éªŒè¯åŠŸèƒ½æ­£ç¡®æ€§
5. **ç”¨æˆ·ä½“éªŒå‹å¥½**: é¿å…é•¿æ—¶é—´åŠŸèƒ½ä¸å¯ç”¨

### åŒå­—æ®µè¿‡æ¸¡æœŸæŠ€æœ¯å®ç°

#### æ•°æ®åŒæ­¥ç­–ç•¥
```kotlin
// Entityä¸­çš„åŒæ­¥é€»è¾‘ç¤ºä¾‹
@Entity(tableName = "assets")
data class AssetEntity(
    // åŸå­—æ®µ
    val shares: Double?,
    val unitValue: Double?,
    
    // æ–°å­—æ®µ  
    val sharesDecimal: String?,
    val unitValueDecimal: String?,
    
    // å…¶ä»–å­—æ®µ...
) {
    // ç¡®ä¿è¯»å–æ—¶ä¼˜å…ˆä½¿ç”¨BigDecimalå­—æ®µ
    fun getSharesValue(): BigDecimal? = 
        sharesDecimal?.let { BigDecimal(it) } ?: shares?.let { BigDecimal.valueOf(it) }
        
    fun getUnitValueValue(): BigDecimal? =
        unitValueDecimal?.let { BigDecimal(it) } ?: unitValue?.let { BigDecimal.valueOf(it) }
        
    // å†™å…¥æ—¶åŒæ—¶æ›´æ–°ä¸¤ä¸ªå­—æ®µ
    companion object {
        fun createWithShares(shares: BigDecimal?): AssetEntity {
            return AssetEntity(
                shares = shares?.toDouble(),
                sharesDecimal = shares?.toString(),
                // ...
            )
        }
    }
}
```

#### æ•°æ®åº“è¿ç§»ç¤ºä¾‹
```sql
-- æ­¥éª¤2: æ·»åŠ BigDecimalå­—æ®µ
ALTER TABLE assets ADD COLUMN sharesDecimal TEXT;
ALTER TABLE assets ADD COLUMN unitValueDecimal TEXT;

-- æ•°æ®è¿ç§»è„šæœ¬
UPDATE assets SET 
    sharesDecimal = CAST(shares AS TEXT),
    unitValueDecimal = CAST(unitValue AS TEXT)
WHERE shares IS NOT NULL OR unitValue IS NOT NULL;

-- æ­¥éª¤8: æ¸…ç†é˜¶æ®µåˆ é™¤æ—§å­—æ®µ  
ALTER TABLE assets DROP COLUMN shares;
ALTER TABLE assets DROP COLUMN unitValue;
```

#### è®¡ç®—ç±»é€‚é…ç¤ºä¾‹
```kotlin
class BuyOpportunityCalculator {
    // åŸæ–¹æ³•ä¿æŒä¸å˜
    fun calculate(portfolio: Portfolio): List<TradingOpportunity> { ... }
    
    // æ–°å¢BigDecimalç‰ˆæœ¬
    fun calculateWithDecimal(portfolio: Portfolio): List<TradingOpportunity> {
        val totalAssets = portfolio.assets.sumOf { it.currentMarketValueDecimal } + portfolio.cashDecimal
        // BigDecimalç²¾ç¡®è®¡ç®—é€»è¾‘...
    }
    
    // è¿‡æ¸¡æœŸæ¯”è¾ƒæ–¹æ³• (ç”¨äºéªŒè¯ä¸€è‡´æ€§)
    fun validateConsistency(portfolio: Portfolio): Boolean {
        val oldResult = calculate(portfolio)
        val newResult = calculateWithDecimal(portfolio)
        return compareResults(oldResult, newResult)
    }
}

## å¤‡æ³¨

æ­¤æ”¹é€ é‡‡ç”¨æ¸è¿›å¼é‡æ„ç­–ç•¥ï¼Œç¡®ä¿æ¯ä¸€æ­¥éƒ½å¯ç¼–è¯‘å’Œæµ‹è¯•ï¼Œå»ºè®®ï¼š

### å¼€å‘æµç¨‹
1. **åˆ›å»ºfeatureåˆ†æ”¯**: `feature/bigdecimal-migration`
2. **æ¯ä¸ªæ­¥éª¤ä¸€ä¸ªå°åˆ†æ”¯**: `step-1-infrastructure`, `step-2-database` ç­‰
3. **é¢‘ç¹æäº¤**: æ¯å®Œæˆä¸€ä¸ªå°åŠŸèƒ½å°±æäº¤
4. **æ¯æ­¥éªŒè¯**: ç¡®ä¿ç¼–è¯‘é€šè¿‡å’ŒåŸºæœ¬åŠŸèƒ½æ­£å¸¸

### æµ‹è¯•ç­–ç•¥
1. **å•å…ƒæµ‹è¯•ä¼˜å…ˆ**: æ¯ä¸ªæ–°æ–¹æ³•éƒ½è¦æœ‰å¯¹åº”æµ‹è¯•
2. **å¯¹æ¯”æµ‹è¯•**: è¿‡æ¸¡æœŸæ–°æ—§æ–¹æ³•ç»“æœå¯¹æ¯”éªŒè¯
3. **é›†æˆæµ‹è¯•**: æ¯ä¸ªæ­¥éª¤å®Œæˆåè¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
4. **æ€§èƒ½æµ‹è¯•**: å…³é”®è·¯å¾„çš„æ€§èƒ½å›å½’æµ‹è¯•

### å›æ»šç­–ç•¥
1. **éšæ—¶å¯å›æ»š**: æ¯ä¸€æ­¥éƒ½ä¿æŒä»£ç ç¨³å®šçŠ¶æ€
2. **æ•°æ®å®‰å…¨**: åŒå­—æ®µè¿‡æ¸¡æœŸä¿è¯æ•°æ®ä¸ä¸¢å¤±
3. **åŠŸèƒ½å¼€å…³**: å¯ä»¥é€šè¿‡é…ç½®åˆ‡æ¢æ–°æ—§å®ç°
4. **ç›‘æ§å‘Šè­¦**: éƒ¨ç½²åå¯†åˆ‡ç›‘æ§å…³é”®æŒ‡æ ‡

### å›¢é˜Ÿåä½œ
1. **ä»£ç å®¡æŸ¥**: æ¯ä¸ªæ­¥éª¤éƒ½éœ€è¦ä»”ç»†çš„ä»£ç å®¡æŸ¥
2. **æ–‡æ¡£æ›´æ–°**: åŠæ—¶æ›´æ–°ç›¸å…³æŠ€æœ¯æ–‡æ¡£
3. **çŸ¥è¯†åˆ†äº«**: å®šæœŸåˆ†äº«é‡æ„è¿›å±•å’ŒæŠ€æœ¯ç»†èŠ‚
4. **é£é™©æ²Ÿé€š**: åŠæ—¶å‘ç›¸å…³äººå‘˜é€šæŠ¥é£é™©å’Œè¿›å±•

### ä¸Šçº¿ç­–ç•¥
1. **æµ‹è¯•ç¯å¢ƒéªŒè¯**: æ¯ä¸ªæ­¥éª¤åœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯
2. **ç°åº¦å‘å¸ƒ**: ä¼˜å…ˆåœ¨å†…éƒ¨ç¯å¢ƒæˆ–å°èŒƒå›´ç”¨æˆ·éªŒè¯
3. **ç›‘æ§æŒ‡æ ‡**: é‡ç‚¹ç›‘æ§è®¡ç®—ç²¾åº¦ã€æ€§èƒ½å’Œé”™è¯¯ç‡
4. **å¿«é€Ÿå“åº”**: å‡†å¤‡å¿«é€Ÿå›æ»šå’Œé—®é¢˜ä¿®å¤æœºåˆ¶

---

## å®æ–½è¿›åº¦è·Ÿè¸ª

### âœ… æ­¥éª¤1: åŸºç¡€è®¾æ–½å‡†å¤‡ (å·²å®Œæˆ - 2024/09/22)

**ç›®æ ‡**: æ·»åŠ BigDecimalæ”¯æŒåŸºç¡€è®¾æ–½ï¼Œä¸å½±å“ç°æœ‰ä»£ç 

#### å®Œæˆçš„ä»»åŠ¡ï¼š

1. **âœ… åˆ›å»ºMoneyUtilså·¥å…·ç±»**
   - æ–‡ä»¶ï¼š`ui/common/util/MoneyUtils.kt` (297è¡Œ)
   - åŠŸèƒ½ï¼š
     - ç»Ÿä¸€ç²¾åº¦é…ç½® (é‡‘é¢4ä½ï¼Œä»½é¢6ä½ï¼Œä»·æ ¼4ä½å°æ•°)
     - ç»Ÿä¸€èˆå…¥è§„åˆ™ (HALF_UPå››èˆäº”å…¥)
     - å®‰å…¨æ•°å­¦è¿ç®— (`safeDivide`, `safeMultiply`)
     - æ ¼å¼åŒ–åŠŸèƒ½ (é‡‘é¢ã€ä»½é¢ã€ä»·æ ¼ã€ç™¾åˆ†æ¯”)
     - å¸¸ç”¨å¸¸é‡ (`ZERO_MONEY`, `ONE_MONEY` ç­‰)

2. **âœ… æ·»åŠ BigDecimalåºåˆ—åŒ–å™¨**
   - æ–‡ä»¶ï¼šä¿®æ”¹ `data/network/JsonSerializers.kt`
   - æ–°å¢ï¼š
     - `BigDecimalSerializer` (æ”¯æŒnullå€¼)
     - `BigDecimalNotNullSerializer` (ä¸æ”¯æŒnullå€¼)
   - ç‰¹æ€§ï¼šå­—ç¬¦ä¸²åºåˆ—åŒ–ä¿è¯ç²¾åº¦ä¸ä¸¢å¤±ï¼ŒåŒ…å«å¼‚å¸¸å¤„ç†

3. **âœ… åˆ›å»ºRoomç±»å‹è½¬æ¢å™¨**
   - æ–‡ä»¶ï¼šä¿®æ”¹ `data/database/converters/Converters.kt`
   - æ–°å¢ï¼š`fromBigDecimal`/`toBigDecimal` è½¬æ¢å™¨
   - ç‰¹æ€§ï¼šBigDecimal â†” String æ•°æ®åº“å­˜å‚¨ï¼ŒåŒ…å«å¼‚å¸¸å¤„ç†

4. **âœ… æ·»åŠ BigDecimalæ‰©å±•å‡½æ•°**
   - æ–‡ä»¶ï¼š`ui/common/util/MoneyUtils.kt` (åŒ…å«åœ¨å·¥å…·ç±»æ–‡ä»¶ä¸­)
   - åŠŸèƒ½ï¼š
     - ç²¾åº¦è½¬æ¢ï¼š`toMoney()`, `toShare()`, `toPrice()`
     - æ ¼å¼åŒ–ï¼š`toMoneyString()`, `toShareString()`, `toPriceString()`
     - æ•°å­¦è¿ç®—ï¼š`safeDivide()`, `safeMultiply()`
     - é€»è¾‘åˆ¤æ–­ï¼š`isZero()`, `isPositive()`, `isNegative()`
     - ç±»å‹è½¬æ¢ï¼šString/Double â†’ BigDecimal

#### éªŒè¯ç»“æœï¼š
- **âœ… ç¼–è¯‘çŠ¶æ€**: BUILD SUCCESSFUL (å·²é€šè¿‡Kotlinç¼–è¯‘)
- **âœ… LintingçŠ¶æ€**: æ— é”™è¯¯
- **âœ… ç°æœ‰åŠŸèƒ½**: ä¸å—å½±å“ï¼Œå®Œå…¨å‘åå…¼å®¹
- **âœ… ä»£ç è´¨é‡**: å·²ä¿®å¤æ‰€æœ‰ç¼–è¯‘è­¦å‘Š

#### æŠ€æœ¯è§„æ ¼ï¼š
```kotlin
// ç²¾åº¦é…ç½®
MoneyUtils.MONEY_SCALE = 4    // é‡‘é¢ç²¾åº¦
MoneyUtils.SHARE_SCALE = 6    // ä»½é¢ç²¾åº¦  
MoneyUtils.PRICE_SCALE = 4    // ä»·æ ¼ç²¾åº¦
MoneyUtils.DEFAULT_ROUNDING = RoundingMode.HALF_UP

// ä½¿ç”¨ç¤ºä¾‹
val money = "1234.5678".toBigDecimalMoney()  // BigDecimal(1234.5678)
val formatted = money.toMoneyString()        // "Â¥1234.57"
val shares = 100.5.toBigDecimalShare()       // BigDecimal(100.500000)
```

#### åˆ›å»º/ä¿®æ”¹çš„æ–‡ä»¶ï¼š
1. **æ–°å»º**: `ui/common/util/MoneyUtils.kt` (297è¡Œ)
2. **ä¿®æ”¹**: `data/network/JsonSerializers.kt` (+45è¡Œ)
3. **ä¿®æ”¹**: `data/database/converters/Converters.kt` (+21è¡Œ)

**çŠ¶æ€**: âœ… **å®Œæˆ** (æ‰€æœ‰å­ä»»åŠ¡å·²å®Œæˆï¼ŒéªŒè¯é€šè¿‡)

---

### âœ… æ­¥éª¤2: æ•°æ®åº“åŒå­—æ®µè¿‡æ¸¡ (å·²å®Œæˆ - 2024/09/22)

**ç›®æ ‡**: åœ¨Entityä¸­æ·»åŠ BigDecimalå­—æ®µï¼Œä¿ç•™åŸDoubleå­—æ®µ

#### å®Œæˆçš„ä»»åŠ¡ï¼š

1. **âœ… ç»™AssetEntityæ·»åŠ BigDecimalå­—æ®µ**
   - æ·»åŠ  `sharesDecimal: BigDecimal?`ã€`unitValueDecimal: BigDecimal?` å­—æ®µ
   - å®ç°åŒæ­¥é€»è¾‘æ–¹æ³•ï¼š`getSharesValue()`, `getUnitValueValue()`, `getCurrentMarketValueDecimal()`
   - æ·»åŠ  `createWithDecimal()` å’Œ `withSyncedFields()` æ–¹æ³•

2. **âœ… ç»™TransactionEntityæ·»åŠ BigDecimalå­—æ®µ**
   - æ·»åŠ  `sharesDecimal`, `priceDecimal`, `feeDecimal`, `amountDecimal` å­—æ®µ
   - å®ç°åŒæ­¥é€»è¾‘æ–¹æ³•ï¼š`getSharesValue()`, `getPriceValue()`, `getFeeValue()`, `getAmountValue()`
   - æ·»åŠ  `createWithDecimal()` å’Œ `withSyncedFields()` æ–¹æ³•
   - ä¿®å¤ `@Contextual` æ³¨è§£é—®é¢˜

3. **âœ… ç»™PortfolioEntityæ·»åŠ BigDecimalå­—æ®µ**
   - æ·»åŠ  `cashDecimal: BigDecimal?` å­—æ®µ
   - å®ç°åŒæ­¥é€»è¾‘æ–¹æ³•ï¼š`getCashValue()`, `withSyncedFields()`
   - æ·»åŠ  `create()` å’Œ `createWithDecimal()` å·¥å‚æ–¹æ³•

4. **âœ… ç»™TradingOpportunityEntityæ·»åŠ BigDecimalå­—æ®µ**
   - æ·»åŠ å®Œæ•´çš„BigDecimalå­—æ®µæ”¯æŒ (æ–°å¢ä»»åŠ¡)
   - å®ç°ç›¸åŒçš„åŒæ­¥é€»è¾‘æ¨¡å¼

5. **âœ… åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬**
   - æ•°æ®åº“ç‰ˆæœ¬: 10 â†’ 11
   - ä¸ºæ‰€æœ‰è¡¨æ·»åŠ  BigDecimal å­—æ®µ (TEXTç±»å‹å­˜å‚¨)
   - è‡ªåŠ¨æ•°æ®è¿ç§»ï¼šå°†ç°æœ‰ Double å€¼è½¬æ¢ä¸º BigDecimal å­—ç¬¦ä¸²
   - æ”¯æŒå››ä¸ªè¡¨ï¼š`assets`, `transactions`, `portfolio`, `trading_opportunities`

6. **âœ… ä¿®å¤ç¼–è¯‘é—®é¢˜**
   - ä¿®å¤ `LocalDateTime` åºåˆ—åŒ–é—®é¢˜ (æ·»åŠ  `@Contextual` æ³¨è§£)
   - ä¿®å¤ `PortfolioRepository` ä¸­çš„æ„é€ å‡½æ•°è°ƒç”¨
   - ç¡®ä¿æ‰€æœ‰Entityçš„ `create()` æ–¹æ³•æ­£ç¡®åŒæ­¥BigDecimalå­—æ®µ

#### éªŒè¯ç»“æœï¼š
- **âœ… ç¼–è¯‘çŠ¶æ€**: BUILD SUCCESSFUL 
- **âœ… æ•°æ®åº“è¿ç§»**: ç‰ˆæœ¬11è¿ç§»è„šæœ¬å°±ç»ª
- **âœ… åŒå­—æ®µåŒæ­¥**: æ‰€æœ‰Entityæ”¯æŒæ–°æ—§å­—æ®µè‡ªåŠ¨åŒæ­¥
- **âœ… å‘åå…¼å®¹**: ç°æœ‰ä»£ç ç»§ç»­æ­£å¸¸å·¥ä½œ

#### æŠ€æœ¯å®ç°ï¼š
```kotlin
// åŒå­—æ®µåŒæ­¥ç¤ºä¾‹
data class AssetEntity(
    val shares: Double?,
    val sharesDecimal: BigDecimal?, // æ–°å­—æ®µ
    // ...
) {
    fun getSharesValue(): BigDecimal? {
        return sharesDecimal ?: shares?.let { BigDecimal.valueOf(it) }
    }
}

// æ•°æ®åº“è¿ç§»ç¤ºä¾‹
db.execSQL("ALTER TABLE assets ADD COLUMN sharesDecimal TEXT")
db.execSQL("UPDATE assets SET sharesDecimal = CAST(shares AS TEXT)")
```

#### ä¿®æ”¹çš„æ–‡ä»¶ï¼š
1. **ä¿®æ”¹**: `AssetEntity.kt` (+40è¡Œ)
2. **ä¿®æ”¹**: `TransactionEntity.kt` (+78è¡Œ) 
3. **ä¿®æ”¹**: `PortfolioEntity.kt` (+55è¡Œ)
4. **ä¿®æ”¹**: `TradingOpportunityEntity.kt` (+78è¡Œ)
5. **ä¿®æ”¹**: `AppDatabase.kt` (+35è¡Œ, ç‰ˆæœ¬10â†’11)
6. **ä¿®æ”¹**: `PortfolioRepository.kt` (3å¤„æ„é€ å‡½æ•°è°ƒç”¨ä¿®å¤)

**çŠ¶æ€**: âœ… **å®Œæˆ** (æ‰€æœ‰Entityæ”¯æŒBigDecimalåŒå­—æ®µï¼Œæ•°æ®åº“è¿ç§»å°±ç»ª)

---

### âœ… æ­¥éª¤3: åŸŸæ¨¡å‹åŒå­—æ®µè¿‡æ¸¡ (å·²å®Œæˆ - 2024/09/22)

**ç›®æ ‡**: åœ¨Domain modelsä¸­æ·»åŠ BigDecimalå­—æ®µï¼Œä¿ç•™åŸå­—æ®µ

#### å®Œæˆçš„ä»»åŠ¡ï¼š

1. **âœ… ç»™Assetæ·»åŠ BigDecimalå­—æ®µ**
   - æ·»åŠ  `sharesDecimal: BigDecimal?`ã€`unitValueDecimal: BigDecimal?` å­—æ®µ
   - å®ç°è®¡ç®—å±æ€§ï¼š`currentMarketValueDecimal: BigDecimal`
   - å®ç°åŒæ­¥é€»è¾‘æ–¹æ³•ï¼š`getSharesValue()`, `getUnitValueValue()`, `withSyncedFields()`

2. **âœ… ç»™Portfolioæ·»åŠ BigDecimalå­—æ®µ**
   - æ·»åŠ  `cashDecimal: BigDecimal?` å­—æ®µ
   - å®ç°è®¡ç®—å±æ€§ï¼š`totalAssetsValueDecimal: BigDecimal`
   - å®ç°åŒæ­¥é€»è¾‘æ–¹æ³•ï¼š`getCashValue()`, `withSyncedFields()`

3. **âœ… ç»™Transactionæ·»åŠ BigDecimalå­—æ®µ**
   - æ·»åŠ  `sharesDecimal`, `priceDecimal`, `feeDecimal`, `amountDecimal` å­—æ®µ
   - å®ç°åŒæ­¥é€»è¾‘æ–¹æ³•ï¼š`getSharesValue()`, `getPriceValue()`, `getFeeValue()`, `getAmountValue()`
   - æ·»åŠ  `withSyncedFields()` æ–¹æ³•

4. **âœ… ç»™TradingOpportunityæ·»åŠ BigDecimalå­—æ®µ**
   - æ·»åŠ å®Œæ•´çš„BigDecimalå­—æ®µæ”¯æŒ
   - å®ç°ç›¸åŒçš„åŒæ­¥é€»è¾‘æ¨¡å¼

5. **âœ… æ›´æ–°åºåˆ—åŒ–æ”¯æŒ**
   - åœ¨serializationModuleä¸­æ”¯æŒBigDecimalåºåˆ—åŒ–
   - æ‰€æœ‰BigDecimalå­—æ®µä½¿ç”¨ `@Serializable(with = BigDecimalSerializer::class)` æ³¨è§£

6. **âœ… æ·»åŠ Entity â†” Domainè½¬æ¢åŒå‘åŒæ­¥**
   - æ›´æ–° `AssetEntity.toDomain()` / `Asset.toEntity()` æ–¹æ³•
   - æ›´æ–° `TransactionEntity.toDomain()` / `Transaction.toEntity()` æ–¹æ³•
   - æ›´æ–° `TradingOpportunityEntity.toDomain()` / `TradingOpportunity.toEntity()` æ–¹æ³•
   - æ‰€æœ‰è½¬æ¢æ–¹æ³•ä¼˜å…ˆä½¿ç”¨BigDecimalå­—æ®µ

7. **âœ… ä¿®å¤ç¼–è¯‘é—®é¢˜**
   - ä¿®å¤BigDecimalåºåˆ—åŒ–å™¨æ³¨å†Œé—®é¢˜
   - ä¿®å¤Portfolioæ„é€ å‡½æ•°è°ƒç”¨å‚æ•°é—®é¢˜

#### éªŒè¯ç»“æœï¼š
- **âœ… ç¼–è¯‘çŠ¶æ€**: BUILD SUCCESSFUL
- **âœ… æ•°æ®è½¬æ¢**: Entity â†” DomainåŒå‘åŒæ­¥æ­£å¸¸
- **âœ… åºåˆ—åŒ–**: BigDecimalå­—æ®µåºåˆ—åŒ–æ”¯æŒå®Œæ•´
- **âœ… å‘åå…¼å®¹**: ç°æœ‰ä»£ç ç»§ç»­æ­£å¸¸å·¥ä½œ

#### æŠ€æœ¯å®ç°ï¼š
```kotlin
// åŸŸæ¨¡å‹BigDecimalå­—æ®µç¤ºä¾‹
@Serializable
data class Asset(
    val shares: Double? = null,
    @Serializable(with = BigDecimalSerializer::class)
    val sharesDecimal: BigDecimal? = null,
    // ...
) {
    fun getSharesValue(): BigDecimal? {
        return sharesDecimal ?: shares?.let { BigDecimal.valueOf(it) }
    }
    
    val currentMarketValueDecimal: BigDecimal
        get() = getSharesValue()?.multiply(getUnitValueValue() ?: BigDecimal.ZERO) ?: BigDecimal.ZERO
}

// Entity â†” Domainè½¬æ¢ç¤ºä¾‹
private fun AssetEntity.toDomain(): Asset = Asset(
    // Doubleå­—æ®µ
    shares = shares,
    unitValue = unitValue,
    // BigDecimalå­—æ®µï¼ˆä¼˜å…ˆä½¿ç”¨ï¼‰
    sharesDecimal = getSharesValue(),
    unitValueDecimal = getUnitValueValue(),
    // ...
)
```

#### ä¿®æ”¹çš„æ–‡ä»¶ï¼š
1. **ä¿®æ”¹**: `Domain.kt` (+150è¡Œ) - æ ¸å¿ƒåŸŸæ¨¡å‹BigDecimalæ”¯æŒ
2. **ä¿®æ”¹**: `PortfolioRepository.kt` (+35è¡Œ) - Entity â†” Domainè½¬æ¢é€»è¾‘æ›´æ–°

**çŠ¶æ€**: âœ… **å®Œæˆ** (æ‰€æœ‰åŸŸæ¨¡å‹æ”¯æŒBigDecimalï¼Œè½¬æ¢é€»è¾‘å®Œæ•´)

---

### âœ… æ­¥éª¤4: è®¡ç®—ç±»é€‚é…å±‚ (å·²å®Œæˆ - 2024/09/22)

**ç›®æ ‡**: åœ¨è®¡ç®—ç±»ä¸­æ·»åŠ BigDecimalç‰ˆæœ¬çš„æ–¹æ³•ï¼Œä¿ç•™åŸæ–¹æ³•

#### å®Œæˆçš„ä»»åŠ¡ï¼š

1. **âœ… BuyOpportunityCalculator BigDecimalé€‚é…**
   - æ·»åŠ BigDecimalç‰ˆæœ¬å¸¸é‡ï¼š`handSizeDecimal`, `minSingleAmountRatioDecimal`, `minAbsoluteAmountDecimal`, `maxBuyWeeksDecimal`, `defaultFeeDecimal`
   - å®ç° `calculateWithDecimal()` æ–¹æ³•ï¼šä½¿ç”¨BigDecimalè¿›è¡Œç²¾ç¡®çš„ä¹°å…¥æœºä¼šè®¡ç®—
   - å®ç° `sharesAndAmountDecimal()` æ–¹æ³•ï¼šBigDecimalç‰ˆæœ¬çš„ä»½é¢å’Œé‡‘é¢è®¡ç®—
   - æ·»åŠ  `validateConsistency()` æ–¹æ³•ï¼šéªŒè¯æ–°æ—§æ–¹æ³•ç»“æœä¸€è‡´æ€§

2. **âœ… SellOpportunityCalculator BigDecimalé€‚é…**
   - æ·»åŠ BigDecimalç‰ˆæœ¬å¸¸é‡ï¼š`handSizeDecimal`, `minAbsoluteAmountDecimal`, `defaultFeeDecimal`, `minDeviationDecimal`
   - å®ç° `calculateWithDecimal()` æ–¹æ³•ï¼šä½¿ç”¨BigDecimalè¿›è¡Œç²¾ç¡®çš„å–å‡ºæœºä¼šè®¡ç®—
   - å®ç° `sharesAndAmountDecimal()` æ–¹æ³•ï¼šBigDecimalç‰ˆæœ¬çš„ä»½é¢å’Œé‡‘é¢è®¡ç®—
   - æ·»åŠ  `validateConsistency()` æ–¹æ³•ï¼šéªŒè¯æ–°æ—§æ–¹æ³•ç»“æœä¸€è‡´æ€§

3. **âœ… AssetInfoæ¨¡å‹BigDecimalæ”¯æŒ**
   - åœ¨AssetInfoä¸­æ·»åŠ BigDecimalå­—æ®µï¼š`marketValueDecimal`, `currentWeightDecimal`, `deviationPctDecimal`, `targetMarketValueDecimal`, `deviationValueDecimal`
   - å®ç°åŒæ­¥é€»è¾‘æ–¹æ³•ï¼š`getMarketValueValue()`, `getCurrentWeightValue()`, `getDeviationPctValue()`, `getTargetMarketValueValue()`, `getDeviationValueValue()`

4. **âœ… AssetInfoCalc BigDecimalé€‚é…**
   - å®ç° `buildAssetInfoWithDecimal()` å‡½æ•°ï¼šä½¿ç”¨BigDecimalè¿›è¡Œç²¾ç¡®çš„AssetInfoè®¡ç®—
   - æ·»åŠ  `validateAssetInfoConsistency()` å‡½æ•°ï¼šéªŒè¯æ–°æ—§æ–¹æ³•ç»“æœä¸€è‡´æ€§
   - ä¿ç•™åŸ`buildAssetInfo()`å‡½æ•°ç¡®ä¿å‘åå…¼å®¹

5. **âœ… BigDecimalå¸¸é‡æ ‡å‡†åŒ–**
   - æ‰€æœ‰è®¡ç®—ç±»ä½¿ç”¨MoneyUtilsä¸­å®šä¹‰çš„ç²¾åº¦å’Œèˆå…¥è§„åˆ™
   - ç»Ÿä¸€ä½¿ç”¨ `MoneyUtils.createMoney()`, `MoneyUtils.createShare()` åˆ›å»ºBigDecimalå€¼
   - æ‰€æœ‰æ ¼å¼åŒ–è¾“å‡ºä½¿ç”¨ `MoneyUtils.formatMoney()`, `MoneyUtils.formatShare()`, `MoneyUtils.formatPercentage()`

6. **âœ… ä¿®å¤ç¼–è¯‘é—®é¢˜**
   - ä¿®å¤æ‰©å±•å‡½æ•°è°ƒç”¨ï¼Œæ”¹ä¸ºä½¿ç”¨MoneyUtilsé™æ€æ–¹æ³•
   - ç¡®ä¿æ‰€æœ‰BigDecimalè®¡ç®—ä½¿ç”¨å®‰å…¨çš„é™¤æ³•å’Œä¹˜æ³•æ–¹æ³•

#### éªŒè¯ç»“æœï¼š
- **âœ… ç¼–è¯‘çŠ¶æ€**: BUILD SUCCESSFUL
- **âœ… ç²¾ç¡®è®¡ç®—**: æ‰€æœ‰é‡‘é¢ã€ä»½é¢è®¡ç®—ä½¿ç”¨BigDecimalé¿å…ç²¾åº¦æŸå¤±
- **âœ… å‘åå…¼å®¹**: ç°æœ‰Doubleç‰ˆæœ¬æ–¹æ³•ç»§ç»­æ­£å¸¸å·¥ä½œ
- **âœ… ä¸€è‡´æ€§éªŒè¯**: æä¾›äº†éªŒè¯æ–°æ—§æ–¹æ³•ç»“æœä¸€è‡´æ€§çš„å·¥å…·

#### æŠ€æœ¯å®ç°ï¼š
```kotlin
// è®¡ç®—ç±»BigDecimalé€‚é…ç¤ºä¾‹
class BuyOpportunityCalculator {
    // åŸDoubleç‰ˆæœ¬å¸¸é‡ (ä¿ç•™å‘åå…¼å®¹æ€§)
    private val handSize = 100.0
    private val defaultFee = 5.0
    
    // æ–°BigDecimalç‰ˆæœ¬å¸¸é‡
    private val handSizeDecimal = MoneyUtils.createShare("100")
    private val defaultFeeDecimal = MoneyUtils.createMoney("5")
    
    // åŸæ–¹æ³•ä¿æŒä¸å˜
    fun calculate(portfolio: Portfolio): List<TradingOpportunity> { /* ... */ }
    
    // æ–°BigDecimalç‰ˆæœ¬æ–¹æ³•
    fun calculateWithDecimal(portfolio: Portfolio): List<TradingOpportunity> {
        val total = portfolio.totalAssetsValueDecimal  // ä½¿ç”¨BigDecimalå­—æ®µ
        val pendingAmount = portfolio.getCashValue()   // ä¼˜å…ˆä½¿ç”¨BigDecimal
        // æ‰€æœ‰è®¡ç®—ä½¿ç”¨MoneyUtilså®‰å…¨æ–¹æ³•
        val amountPlan = MoneyUtils.safeDivide(pendingAmount, maxBuyWeeksDecimal)
        // æ‰€æœ‰æ ¼å¼åŒ–ä½¿ç”¨MoneyUtilsæ–¹æ³•
        log.appendLine("æ€»èµ„äº§ï¼š${MoneyUtils.formatMoney(total)}")
        // ...
    }
    
    // ä¸€è‡´æ€§éªŒè¯
    fun validateConsistency(portfolio: Portfolio): Boolean {
        val oldResult = calculate(portfolio)
        val newResult = calculateWithDecimal(portfolio)
        return oldResult.zip(newResult).all { (old, new) ->
            MoneyUtils.isEqual(new.getAmountValue(), old.getAmountValue(), MoneyUtils.MONEY_SCALE)
        }
    }
}
```

#### ä¿®æ”¹çš„æ–‡ä»¶ï¼š
1. **ä¿®æ”¹**: `BuyOpportunityCalculator.kt` (+140è¡Œ) - ä¹°å…¥æœºä¼šè®¡ç®—BigDecimalé€‚é…
2. **ä¿®æ”¹**: `SellOpportunityCalculator.kt` (+120è¡Œ) - å–å‡ºæœºä¼šè®¡ç®—BigDecimalé€‚é…
3. **ä¿®æ”¹**: `AssetInfo.kt` (+45è¡Œ) - UIæ¨¡å‹BigDecimalå­—æ®µæ”¯æŒ
4. **ä¿®æ”¹**: `AssetInfoCalc.kt` (+75è¡Œ) - AssetInfoæ„å»ºBigDecimalé€‚é…

**çŠ¶æ€**: âœ… **å®Œæˆ** (æ‰€æœ‰è®¡ç®—ç±»æ”¯æŒBigDecimalï¼Œç²¾ç¡®è®¡ç®—å°±ç»ª)

**æ³¨æ„**: æ­¥éª¤4æš‚æ—¶è·³è¿‡äº†BuyFactorCalculatorå’ŒSellThresholdCalculatorçš„é€‚é…ï¼Œè¿™äº›å°†åœ¨åç»­æ­¥éª¤ä¸­æ ¹æ®éœ€è¦è¿›è¡Œã€‚

---

### âœ… æ­¥éª¤5: UIæ¨¡å‹åŒå­—æ®µè¿‡æ¸¡ (å·²å®Œæˆ - 2024/09/22)

**ç›®æ ‡**: åœ¨ViewModelå’ŒUIçŠ¶æ€ç®¡ç†ä¸­æ·»åŠ BigDecimalå­—æ®µæ”¯æŒï¼Œä¿ç•™åŸå­—æ®µ

#### å®Œæˆçš„ä»»åŠ¡ï¼š

1. **âœ… PortfolioViewModel BigDecimalé€‚é…**
   - æ·»åŠ BigDecimalç‰ˆæœ¬çš„èµ„äº§æ˜ å°„ï¼š`assetId2ValueDecimal`
   - å®ç°BigDecimalç‰ˆæœ¬çš„AssetInfoè®¡ç®—ï¼š`assetAnalysesDecimal`, `sortedAssetAnalysesDecimal`
   - æ·»åŠ BigDecimalç‰ˆæœ¬çš„ç°é‡‘æ›´æ–°ï¼š`updateCashDecimal()`
   - æ’åºé€»è¾‘å®Œå…¨æ”¯æŒBigDecimalå­—æ®µæ¯”è¾ƒ

2. **âœ… AddEditTransactionViewModel BigDecimalé€‚é…**
   - æ·»åŠ BigDecimalç‰ˆæœ¬çš„ä»·æ ¼æµï¼š`currentPriceDecimal`
   - å®ç°ç²¾ç¡®çš„æ€»é‡‘é¢è®¡ç®—ï¼š`totalAmountDecimal`
   - æ·»åŠ BigDecimalç‰ˆæœ¬çš„é¢„è§ˆä¿¡æ¯ï¼š`previewInfosDecimal`
   - å®ç°BigDecimalç‰ˆæœ¬çš„Transactionæ„å»ºï¼š`buildTransactionDecimal()`, `saveWithDecimal()`

3. **âœ… AddEditAssetViewModel BigDecimalé€‚é…**
   - å®ç°BigDecimalç‰ˆæœ¬çš„Assetæ„å»ºï¼š`buildAssetDecimal()`
   - æ·»åŠ BigDecimalç‰ˆæœ¬çš„ä¿å­˜ï¼š`saveWithDecimal()`
   - ç¼–è¾‘æ—¶ä¼˜å…ˆä½¿ç”¨BigDecimalå­—æ®µåŠ è½½æ•°æ®

4. **âœ… TradingOpportunityViewModel BigDecimalé€‚é…**
   - æ·»åŠ BigDecimalç‰ˆæœ¬çš„äº¤æ˜“æœºä¼šè®¡ç®—ï¼š`checkSellWithDecimal()`, `checkBuyWithDecimal()`
   - ä½¿ç”¨æ­¥éª¤4ä¸­å®ç°çš„BigDecimalè®¡ç®—å™¨

5. **âœ… å­—ç¬¦ä¸²è½¬æ¢æ‰©å±•å‡½æ•°é›†æˆ**
   - æ‰€æœ‰ViewModelæ­£ç¡®å¯¼å…¥å’Œä½¿ç”¨`toBigDecimalMoney()`, `toBigDecimalShare()`æ‰©å±•å‡½æ•°
   - ç»Ÿä¸€ä½¿ç”¨MoneyUtilsæ ¼å¼åŒ–æ–¹æ³•

6. **âœ… UI StateåŒå‘åŒæ­¥é€»è¾‘**
   - æ‰€æœ‰ViewModelæä¾›åŒç‰ˆæœ¬ï¼ˆDouble + BigDecimalï¼‰çš„çŠ¶æ€æµ
   - ä¿è¯æ•°æ®ä¸€è‡´æ€§å’Œå‘åå…¼å®¹æ€§

#### éªŒè¯ç»“æœï¼š
- **âœ… ç¼–è¯‘çŠ¶æ€**: BUILD SUCCESSFUL
- **âœ… æ•°æ®æµå®Œæ•´**: UI â†’ ViewModel â†’ Repository â†’ Entity â†’ Domain å…¨é“¾è·¯BigDecimalæ”¯æŒ
- **âœ… å‘åå…¼å®¹**: ç°æœ‰Doubleç‰ˆæœ¬æ–¹æ³•ç»§ç»­æ­£å¸¸å·¥ä½œ
- **âœ… UIæ•°æ®ç²¾åº¦**: æ‰€æœ‰é‡‘é¢è®¡ç®—ä½¿ç”¨BigDecimalé¿å…ç²¾åº¦æŸå¤±

#### æŠ€æœ¯å®ç°ï¼š
```kotlin
// ViewModel BigDecimalé€‚é…ç¤ºä¾‹
@HiltViewModel
class AddEditTransactionViewModel {
    // Doubleç‰ˆæœ¬ (å‘åå…¼å®¹)
    val currentPrice: StateFlow<Double?> = ...
    val totalAmount: StateFlow<String> = ...
    
    // BigDecimalç‰ˆæœ¬ (ç²¾ç¡®è®¡ç®—)
    val currentPriceDecimal: StateFlow<BigDecimal?> = combine(assets, _selectedAssetId) { list, id ->
        list.firstOrNull { it.id == id }?.getUnitValueValue()
    }.stateIn(...)
    
    val totalAmountDecimal: StateFlow<String> = combine(_sharesInput, currentPriceDecimal, _feeInput) { sharesStr, priceDecimal, feeStr ->
        val sharesDecimal = sharesStr.toBigDecimalShare()
        val feeDecimal = feeStr.toBigDecimalMoney()
        if (sharesDecimal == null || priceDecimal == null || feeDecimal == null) return@combine "-"
        val total = MoneyUtils.safeMultiply(sharesDecimal, priceDecimal).add(feeDecimal)
        MoneyUtils.formatMoney(total)
    }.stateIn(...)
    
    // BigDecimalç‰ˆæœ¬çš„æ•°æ®æ„å»º
    private fun buildTransactionDecimal(): Transaction? {
        val sharesDecimal = _sharesInput.value.toBigDecimalShare() ?: return null
        val priceDecimal = currentPriceDecimal.value ?: return null
        val feeDecimal = _feeInput.value.toBigDecimalMoney() ?: MoneyUtils.createMoney("5")
        val amountDecimal = MoneyUtils.safeMultiply(sharesDecimal, priceDecimal).add(feeDecimal)
        
        return Transaction(
            // Doubleå­—æ®µ (å‘åå…¼å®¹)
            shares = sharesDecimal.toDouble(),
            price = priceDecimal.toDouble(),
            fee = feeDecimal.toDouble(),
            amount = amountDecimal.toDouble(),
            // BigDecimalå­—æ®µ (ç²¾ç¡®ç‰ˆæœ¬)
            sharesDecimal = sharesDecimal,
            priceDecimal = priceDecimal,
            feeDecimal = feeDecimal,
            amountDecimal = amountDecimal,
            // ...
        )
    }
}
```

#### ä¿®æ”¹çš„æ–‡ä»¶ï¼š
1. **ä¿®æ”¹**: `PortfolioViewModel.kt` (+70è¡Œ) - æŠ•èµ„ç»„åˆBigDecimalçŠ¶æ€ç®¡ç†
2. **ä¿®æ”¹**: `AddEditTransactionViewModel.kt` (+120è¡Œ) - äº¤æ˜“BigDecimalè¾“å…¥/è®¡ç®—
3. **ä¿®æ”¹**: `AddEditAssetViewModel.kt` (+50è¡Œ) - èµ„äº§BigDecimalç¼–è¾‘
4. **ä¿®æ”¹**: `TradingOpportunityViewModel.kt` (+25è¡Œ) - äº¤æ˜“æœºä¼šBigDecimalè®¡ç®—

**çŠ¶æ€**: âœ… **å®Œæˆ** (æ‰€æœ‰UIå±‚æ”¯æŒBigDecimalï¼Œç”¨æˆ·ç•Œé¢æ•°æ®ç²¾ç¡®)

---

### âœ… æ­¥éª¤6: é€æ­¥åˆ‡æ¢ä¸šåŠ¡é€»è¾‘ (å·²å®Œæˆ - 2024/09/22)

**ç›®æ ‡**: å°†å…³é”®ä¸šåŠ¡æµç¨‹åˆ‡æ¢åˆ°BigDecimalç‰ˆæœ¬ï¼Œä¿æŒå‘åå…¼å®¹æ€§

#### å®Œæˆçš„ä»»åŠ¡ï¼š

1. **âœ… Repositoryå±‚BigDecimalåˆ‡æ¢**
   - **`portfolioFlow`**: åˆ‡æ¢åˆ°ä¼˜å…ˆä½¿ç”¨BigDecimalç°é‡‘å­—æ®µï¼ŒåŒæ—¶ä¿æŒDoubleå­—æ®µåŒæ­¥
   - **`updateCashDecimal()`**: æ–°å¢BigDecimalç‰ˆæœ¬çš„ç°é‡‘æ›´æ–°æ–¹æ³•
   - **`updateCash()`**: å‘åå…¼å®¹çš„Doubleç‰ˆæœ¬ï¼Œå†…éƒ¨è½¬æ¢ä¸ºBigDecimalè°ƒç”¨
   - **`addTransaction()`**: å®Œå…¨åˆ‡æ¢åˆ°BigDecimalç²¾ç¡®è®¡ç®—èµ„äº§ä»½é¢å’Œç°é‡‘å˜åŠ¨
   - **`deleteTransaction()`**: åˆ‡æ¢åˆ°BigDecimalç²¾ç¡®å›æ»šäº¤æ˜“å½±å“
   - **`updateTransaction()`**: åˆ‡æ¢åˆ°BigDecimalç²¾ç¡®å¤„ç†äº¤æ˜“æ›´æ–°çš„å›æ»šå’Œåº”ç”¨

2. **âœ… UseCaseå±‚BigDecimalåˆ‡æ¢**
   - **`UpdateMarketDataUseCase.refreshAsset()`**: åˆ‡æ¢åˆ°BigDecimalè®¾ç½®èµ„äº§å•ä»·
   - **`UpdateMarketDataUseCase.updateAssetAnalyses()`**: ä½¿ç”¨BigDecimalç‰ˆæœ¬çš„æ€»èµ„äº§å€¼è®¡ç®—
   - ä¼˜å…ˆä½¿ç”¨`portfolio.totalAssetsValueDecimal`å’Œ`portfolio.getCashValue()`

3. **âœ… ViewModelå±‚é»˜è®¤æ–¹æ³•åˆ‡æ¢**
   - **`PortfolioViewModel.updateCash()`**: å†…éƒ¨åˆ‡æ¢åˆ°BigDecimalç‰ˆæœ¬è°ƒç”¨
   - **`PortfolioViewModel.updateCashDecimal()`**: è°ƒç”¨Repositoryçš„BigDecimalç‰ˆæœ¬
   - **`TradingOpportunityViewModel.checkSell/checkBuy()`**: é»˜è®¤ä½¿ç”¨BigDecimalç‰ˆæœ¬çš„è®¡ç®—å™¨
   - ä¿ç•™å‘åå…¼å®¹çš„Doubleç‰ˆæœ¬æ–¹æ³•ï¼ˆ`checkSellWithDouble`, `checkBuyWithDouble`ï¼‰

4. **âœ… å…³é”®ä¸šåŠ¡è·¯å¾„è¯†åˆ«ä¸åˆ‡æ¢**
   - **äº¤æ˜“å¤„ç†è·¯å¾„**: æ·»åŠ /æ›´æ–°/åˆ é™¤äº¤æ˜“å…¨éƒ¨ä½¿ç”¨BigDecimalç²¾ç¡®è®¡ç®—
   - **ç°é‡‘ç®¡ç†è·¯å¾„**: æ‰€æœ‰ç°é‡‘æ›´æ–°æ“ä½œä½¿ç”¨BigDecimal
   - **èµ„äº§è®¡ç®—è·¯å¾„**: å¸‚åœºæ•°æ®æ›´æ–°å’Œåˆ†æè®¡ç®—ä½¿ç”¨BigDecimal
   - **äº¤æ˜“æœºä¼šè·¯å¾„**: ä¹°å…¥/å–å‡ºæœºä¼šè®¡ç®—é»˜è®¤ä½¿ç”¨BigDecimal

5. **âœ… æ•°æ®ä¸€è‡´æ€§ä¿è¯**
   - æ‰€æœ‰BigDecimalè®¡ç®—åŒæ—¶ç»´æŠ¤Doubleå­—æ®µåŒæ­¥
   - ç¡®ä¿æ•°æ®åº“å­˜å‚¨æ—¶BigDecimalå’ŒDoubleå­—æ®µä¸€è‡´
   - ä½¿ç”¨`withSyncedFields()`æ–¹æ³•ç¡®ä¿å®ä½“æ•°æ®ä¸€è‡´æ€§

#### éªŒè¯ç»“æœï¼š
- **âœ… ç¼–è¯‘çŠ¶æ€**: BUILD SUCCESSFUL
- **âœ… å‘åå…¼å®¹**: æ‰€æœ‰åŸæœ‰Doubleç‰ˆæœ¬æ–¹æ³•ç»§ç»­å¯ç”¨
- **âœ… æ•°æ®ç²¾åº¦**: å…³é”®ä¸šåŠ¡é€»è¾‘å…¨éƒ¨ä½¿ç”¨BigDecimalç²¾ç¡®è®¡ç®—
- **âœ… æ€§èƒ½å½±å“**: æœ€å°åŒ–ï¼Œåªåœ¨å¿…è¦æ—¶è¿›è¡ŒBigDecimalè½¬æ¢

#### æŠ€æœ¯å®ç°ï¼š

```kotlin
// Repositoryå±‚BigDecimalåˆ‡æ¢ç¤ºä¾‹
class PortfolioRepository {
    // ç°é‡‘æ›´æ–°ï¼šDoubleç‰ˆæœ¬å†…éƒ¨è°ƒç”¨BigDecimalç‰ˆæœ¬
    suspend fun updateCash(cash: Double) {
        updateCashDecimal(BigDecimal.valueOf(cash))
    }
    
    suspend fun updateCashDecimal(cashDecimal: BigDecimal) {
        // ç›´æ¥ä½¿ç”¨BigDecimalè¿›è¡Œç²¾ç¡®è®¡ç®—
        val current = portfolioDao.getPortfolioSuspend()
        if (current == null) {
            portfolioDao.insertPortfolio(PortfolioEntity.createWithDecimal(cashDecimal = cashDecimal))
        } else {
            portfolioDao.updateCash(cashDecimal.toDouble())
        }
    }
    
    // äº¤æ˜“å¤„ç†ï¼šå®Œå…¨ä½¿ç”¨BigDecimalè®¡ç®—
    suspend fun addTransaction(tx: Transaction) {
        db.withTransaction {
            // BigDecimalç²¾ç¡®è®¡ç®—èµ„äº§ä»½é¢å˜åŠ¨
            val currentSharesDecimal = asset.getSharesValue() ?: BigDecimal.ZERO
            val deltaSharesDecimal = tx.getSharesValue()
            val newSharesDecimal = if (tx.type == TradeType.BUY) {
                currentSharesDecimal.add(deltaSharesDecimal)
            } else {
                currentSharesDecimal.subtract(deltaSharesDecimal)
            }
            
            // BigDecimalç²¾ç¡®è®¡ç®—ç°é‡‘å˜åŠ¨
            val cashDeltaDecimal = tx.getAmountValue()
            val finalCashDelta = if (tx.type == TradeType.BUY) {
                cashDeltaDecimal.negate()
            } else {
                cashDeltaDecimal
            }
            // ...
        }
    }
}

// ViewModelå±‚åˆ‡æ¢ç¤ºä¾‹
@HiltViewModel
class PortfolioViewModel {
    fun updateCash(newCash: Double) {
        viewModelScope.launch {
            // å‘åå…¼å®¹ï¼Œå†…éƒ¨è½¬æ¢ä¸ºBigDecimal
            repository.updateCashDecimal(BigDecimal.valueOf(newCash))
        }
    }
}

// TradingOpportunityViewModelé»˜è®¤ä½¿ç”¨BigDecimal
@HiltViewModel  
class TradingOpportunityViewModel {
    fun checkSell() {
        viewModelScope.launch {
            val portfolio = repository.getPortfolioOnce()
            // é»˜è®¤ä½¿ç”¨BigDecimalç‰ˆæœ¬çš„è®¡ç®—å™¨
            val items = sellCalculator.calculateWithDecimal(portfolio)
            if (items.isNotEmpty()) repository.insertTradingOpportunities(items)
        }
    }
}
```

#### åˆ‡æ¢ç­–ç•¥ï¼š
1. **æ¸è¿›å¼åˆ‡æ¢**: å…ˆæ·»åŠ BigDecimalç‰ˆæœ¬ï¼Œç„¶åè®©Doubleç‰ˆæœ¬å†…éƒ¨è°ƒç”¨BigDecimalç‰ˆæœ¬
2. **å‘åå…¼å®¹**: ä¿ç•™æ‰€æœ‰åŸæœ‰APIï¼Œç¡®ä¿ç°æœ‰ä»£ç ç»§ç»­å·¥ä½œ
3. **æ•°æ®åŒæ­¥**: ç¡®ä¿BigDecimalå’ŒDoubleå­—æ®µå§‹ç»ˆä¿æŒä¸€è‡´
4. **æœ€å°å½±å“**: åªåœ¨å…³é”®è®¡ç®—è·¯å¾„åˆ‡æ¢ï¼ŒUIè¾“å…¥è¾“å‡ºä¿æŒä¸å˜

#### ä¿®æ”¹çš„æ–‡ä»¶ï¼š
1. **ä¿®æ”¹**: `PortfolioRepository.kt` (+150è¡Œ) - Repositoryå±‚BigDecimalä¸šåŠ¡é€»è¾‘
2. **ä¿®æ”¹**: `UpdateMarketDataUseCase.kt` (+30è¡Œ) - UseCaseå±‚BigDecimalè®¡ç®—
3. **ä¿®æ”¹**: `PortfolioViewModel.kt` (+15è¡Œ) - ViewModelé»˜è®¤æ–¹æ³•åˆ‡æ¢
4. **ä¿®æ”¹**: `TradingOpportunityViewModel.kt` (+20è¡Œ) - äº¤æ˜“æœºä¼šé»˜è®¤BigDecimal

**çŠ¶æ€**: âœ… **å®Œæˆ** (å…³é”®ä¸šåŠ¡é€»è¾‘å·²åˆ‡æ¢åˆ°BigDecimalï¼Œä¿è¯ç²¾ç¡®è®¡ç®—)

---

### âœ… æ­¥éª¤7: UIå±‚åˆ‡æ¢ (å·²å®Œæˆ - 2024/09/22)

**ç›®æ ‡**: å°†UIç•Œé¢åˆ‡æ¢åˆ°ä½¿ç”¨BigDecimalç‰ˆæœ¬çš„æ•°æ®å’Œæ–¹æ³•ï¼Œæä¾›ç²¾ç¡®çš„ç”¨æˆ·ä½“éªŒ

#### å®Œæˆçš„ä»»åŠ¡ï¼š

1. **âœ… äº¤æ˜“ç›¸å…³UIåˆ‡æ¢**
   - **`AddEditTransactionScreen`**: åˆ‡æ¢åˆ°`saveWithDecimal()`ä¿å­˜æ–¹æ³•
   - **æ€»é‡‘é¢æ˜¾ç¤º**: åˆ‡æ¢åˆ°`totalAmountDecimal`ä½¿ç”¨BigDecimalæ ¼å¼åŒ–æ˜¾ç¤º
   - **ä»·æ ¼æ˜¾ç¤º**: åˆ‡æ¢åˆ°`currentPriceDecimal`å¹¶ä½¿ç”¨`MoneyUtils.formatMoney()`æ ¼å¼åŒ–
   - **é¢„è§ˆä¿¡æ¯**: åˆ‡æ¢åˆ°`previewInfosDecimal`ä½¿ç”¨BigDecimalç‰ˆæœ¬çš„èµ„äº§é¢„è§ˆ

2. **âœ… èµ„äº§ç›¸å…³UIåˆ‡æ¢**
   - **`AddEditAssetScreen`**: åˆ‡æ¢åˆ°`saveWithDecimal()`ä¿å­˜æ–¹æ³•
   - **èµ„äº§åˆ†ææ•°æ®**: åˆ‡æ¢åˆ°`assetAnalysesDecimal`ä½¿ç”¨BigDecimalç‰ˆæœ¬çš„åˆ†ææ•°æ®
   - **è®¡ç®—è¿‡ç¨‹æ˜¾ç¤º**: ä½¿ç”¨BigDecimalç‰ˆæœ¬çš„åˆ†æç»“æœ

3. **âœ… æŠ•èµ„ç»„åˆUIæ•°æ®æµåˆ‡æ¢**
   - **ç°é‡‘ç®¡ç†**: `updateCash()`å·²åœ¨æ­¥éª¤6å†…éƒ¨åˆ‡æ¢åˆ°BigDecimalç‰ˆæœ¬
   - **äº¤æ˜“æœºä¼š**: `checkSell()`å’Œ`checkBuy()`å·²åœ¨æ­¥éª¤6åˆ‡æ¢åˆ°BigDecimalç‰ˆæœ¬
   - **èµ„äº§åˆ—è¡¨**: ä½¿ç”¨BigDecimalç‰ˆæœ¬çš„èµ„äº§ä¿¡æ¯æµ

4. **âœ… UIæ˜¾ç¤ºæ ¼å¼ä¼˜åŒ–**
   - **ä»·æ ¼æ ¼å¼åŒ–**: ä½¿ç”¨`MoneyUtils.formatMoney()`ç»Ÿä¸€æ ¼å¼åŒ–BigDecimalä»·æ ¼
   - **æ€»é‡‘é¢æ ¼å¼åŒ–**: BigDecimalç‰ˆæœ¬çš„`totalAmountDecimal`è¿”å›æ ¼å¼åŒ–å­—ç¬¦ä¸²
   - **ç²¾åº¦ç»Ÿä¸€**: æ‰€æœ‰é‡‘é¢æ˜¾ç¤ºä½¿ç”¨MoneyUtilsç»Ÿä¸€ç²¾åº¦æ ‡å‡†

5. **âœ… æ•°æ®æµä¸€è‡´æ€§**
   - **UIçŠ¶æ€æµ**: æ‰€æœ‰å…³é”®UIç»„ä»¶ä½¿ç”¨BigDecimalç‰ˆæœ¬çš„StateFlow
   - **ç”¨æˆ·è¾“å…¥å¤„ç†**: é€šè¿‡BigDecimalç‰ˆæœ¬çš„ViewModelæ–¹æ³•å¤„ç†
   - **å‘åå…¼å®¹**: ä¿ç•™åŸæœ‰UIæ¥å£ï¼Œå†…éƒ¨è°ƒç”¨BigDecimalç‰ˆæœ¬

6. **âœ… ç”¨æˆ·ä½“éªŒä¿è¯**
   - **æ— æ„ŸçŸ¥åˆ‡æ¢**: ç”¨æˆ·ç•Œé¢å¤–è§‚å’Œæ“ä½œæ–¹å¼ä¿æŒä¸€è‡´
   - **ç²¾åº¦æå‡**: æ‰€æœ‰é‡‘é¢è®¡ç®—å’Œæ˜¾ç¤ºæ›´åŠ ç²¾ç¡®
   - **å“åº”æ€§**: UIå“åº”é€Ÿåº¦å’ŒåŸæ¥ä¸€è‡´

#### éªŒè¯ç»“æœï¼š
- **âœ… ç¼–è¯‘çŠ¶æ€**: BUILD SUCCESSFUL
- **âœ… UIåŠŸèƒ½**: æ‰€æœ‰ç•Œé¢æ­£å¸¸å·¥ä½œï¼Œæ— åŠŸèƒ½ç ´å
- **âœ… æ•°æ®ç²¾åº¦**: UIå±‚é‡‘é¢æ˜¾ç¤ºå’Œè®¡ç®—ä½¿ç”¨BigDecimalç²¾åº¦
- **âœ… ç”¨æˆ·ä½“éªŒ**: ç•Œé¢æ“ä½œæµç¨‹ä¿æŒä¸€è‡´ï¼Œä½“éªŒæ— å˜åŒ–

#### æŠ€æœ¯å®ç°ï¼š

```kotlin
// AddEditTransactionScreen UIåˆ‡æ¢ç¤ºä¾‹
@Composable
fun AddEditTransactionScreen(navController: NavController) {
    val viewModel: AddEditTransactionViewModel = hiltViewModel()
    
    // æ­¥éª¤7: åˆ‡æ¢åˆ°BigDecimalç‰ˆæœ¬çš„çŠ¶æ€æµ
    val currentPrice by viewModel.currentPriceDecimal.collectAsState()
    val totalAmount by viewModel.totalAmountDecimal.collectAsState()
    val previewInfos by viewModel.previewInfosDecimal.collectAsState()
    
    // UIæ˜¾ç¤ºä½¿ç”¨BigDecimalæ ¼å¼åŒ–
    Text(text = "å•ä»·: Â¥${currentPrice?.let { MoneyUtils.formatMoney(it) } ?: "-"}")
    OutlinedTextField(
        value = totalAmount, // å·²ç»æ˜¯æ ¼å¼åŒ–çš„å­—ç¬¦ä¸²
        readOnly = true,
        label = { Text("æ€»é¢") }
    )
    
    // ä¿å­˜ä½¿ç”¨BigDecimalç‰ˆæœ¬
    Button(onClick = {
        coroutineScope.launch {
            val success = viewModel.saveWithDecimal() // ç²¾ç¡®ä¿å­˜
            if (success) navController.navigateUp()
        }
    }) { Text("ä¿å­˜") }
}

// AddEditAssetScreen UIåˆ‡æ¢ç¤ºä¾‹
@Composable
fun AddEditAssetScreen(navController: NavController) {
    val viewModel: AddEditAssetViewModel = hiltViewModel()
    val portfolioViewModel: PortfolioViewModel = hiltViewModel()
    
    // æ­¥éª¤7: ä½¿ç”¨BigDecimalç‰ˆæœ¬çš„èµ„äº§åˆ†ææ•°æ®
    val assetAnalyses by portfolioViewModel.assetAnalysesDecimal.collectAsState()
    
    // ä¿å­˜ä½¿ç”¨BigDecimalç‰ˆæœ¬
    Button(onClick = {
        coroutineScope.launch {
            if (viewModel.saveWithDecimal()) { // ç²¾ç¡®ä¿å­˜
                navController.navigateUp()
            }
        }
    }) { Text("ä¿å­˜") }
}
```

#### UIå±‚åˆ‡æ¢ç­–ç•¥ï¼š
1. **çŠ¶æ€æµåˆ‡æ¢**: UIç»„ä»¶ä½¿ç”¨BigDecimalç‰ˆæœ¬çš„StateFlowï¼ˆå¦‚`totalAmountDecimal`, `currentPriceDecimal`ï¼‰
2. **ä¿å­˜æ–¹æ³•åˆ‡æ¢**: æ‰€æœ‰ä¿å­˜æ“ä½œä½¿ç”¨BigDecimalç‰ˆæœ¬ï¼ˆå¦‚`saveWithDecimal()`ï¼‰
3. **æ ¼å¼åŒ–ç»Ÿä¸€**: ä½¿ç”¨MoneyUtilsç»Ÿä¸€æ ¼å¼åŒ–BigDecimalæ˜¾ç¤º
4. **å‘åå…¼å®¹**: ä¿ç•™åŸæœ‰UIæ¥å£ï¼Œç¡®ä¿æ— ç ´åæ€§å˜æ›´

#### ä¿®æ”¹çš„æ–‡ä»¶ï¼š
1. **ä¿®æ”¹**: `AddEditTransactionScreen.kt` (+10è¡Œ) - äº¤æ˜“UI BigDecimalåˆ‡æ¢
2. **ä¿®æ”¹**: `AddEditAssetScreen.kt` (+5è¡Œ) - èµ„äº§UI BigDecimalåˆ‡æ¢
3. **ä¿æŒ**: `AssetListScreen.kt` - ç°é‡‘æ›´æ–°å·²åœ¨æ­¥éª¤6å†…éƒ¨BigDecimalåŒ–
4. **ä¿æŒ**: `TradingOpportunityListScreen.kt` - äº¤æ˜“æœºä¼šå·²åœ¨æ­¥éª¤6åˆ‡æ¢åˆ°BigDecimal

**çŠ¶æ€**: âœ… **å®Œæˆ** (UIå±‚å®Œå…¨ä½¿ç”¨BigDecimalï¼Œç”¨æˆ·è·å¾—ç²¾ç¡®ä½“éªŒ)

---

### âœ… æ­¥éª¤8: æ¸…ç†Doubleå­—æ®µ (å·²å®Œæˆ - 2024/09/22)

**ç›®æ ‡**: ç§»é™¤ä¸å†ä½¿ç”¨çš„Doubleå­—æ®µå’Œæ–¹æ³•ï¼Œç®€åŒ–ä»£ç ç»“æ„ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§

#### å®Œæˆçš„ä»»åŠ¡ï¼š

1. **âœ… UIå±‚Doubleå­—æ®µæ¸…ç†**
   - **`PortfolioViewModel`**: ç§»é™¤ `assetId2Value`, `assetAnalyses`, `sortedAssetAnalyses` Doubleç‰ˆæœ¬StateFlow
   - **`AddEditTransactionViewModel`**: ç§»é™¤ `currentPrice`, `totalAmount`, `previewInfos` Doubleç‰ˆæœ¬StateFlow
   - **`TradingOpportunityViewModel`**: ç§»é™¤ `checkSellWithDouble()`, `checkBuyWithDouble()` æ–¹æ³•

2. **âœ… UIç»„ä»¶BigDecimalåˆ‡æ¢å®Œæˆ**
   - **`AssetListScreen`**: åˆ‡æ¢åˆ° `assetAnalysesDecimal`, `sortedAssetAnalysesDecimal`
   - **`AssetAnalysisScreen`**: åˆ‡æ¢åˆ° `assetAnalysesDecimal`, `sortedAssetAnalysesDecimal`
   - **æ‰€æœ‰UIç»„ä»¶**: å®Œå…¨ä½¿ç”¨BigDecimalç‰ˆæœ¬çš„æ•°æ®æµå’Œæ–¹æ³•

3. **âœ… ViewModelæ–¹æ³•æ¸…ç†**
   - **ç§»é™¤æ–¹æ³•**: `save()`, `buildTransaction()` (Doubleç‰ˆæœ¬)
   - **ç§»é™¤StateFlow**: æ‰€æœ‰UIå±‚Doubleç‰ˆæœ¬StateFlow
   - **ç§»é™¤é€»è¾‘**: Doubleç‰ˆæœ¬çš„é¢„è§ˆè®¡ç®—å’ŒéªŒè¯é€»è¾‘

4. **âœ… éªŒè¯é€»è¾‘æ›´æ–°**
   - **`canSave`**: æ›´æ–°ä¸ºä½¿ç”¨ `currentPriceDecimal` è¿›è¡ŒéªŒè¯
   - **ä¿æŒå…¼å®¹**: UIæ¥å£å®Œå…¨ä¸€è‡´ï¼Œæ— ç ´åæ€§å˜æ›´

5. **âœ… ä»£ç ç®€åŒ–**
   - **ç§»é™¤å†—ä½™**: å¤§é‡ä¸å†ä½¿ç”¨çš„Doubleç‰ˆæœ¬ä»£ç 
   - **é€»è¾‘ç»Ÿä¸€**: æ‰€æœ‰UIé€»è¾‘ä½¿ç”¨BigDecimalç‰ˆæœ¬
   - **ç»´æŠ¤ç®€åŒ–**: å‡å°‘é‡å¤ä»£ç å’ŒåŒé‡ç»´æŠ¤è´Ÿæ‹…

#### ä¿ç•™çš„é‡è¦ç»„ä»¶ï¼š
- **Entityå±‚**: ä¿ç•™Doubleå­—æ®µç”¨äºæ•°æ®åº“å…¼å®¹æ€§ï¼ˆåŒå­—æ®µç­–ç•¥ï¼‰
- **Domainå±‚**: ä¿ç•™Doubleå­—æ®µç”¨äºå‘åå…¼å®¹
- **Calculatorå±‚**: ä¿ç•™Doubleç‰ˆæœ¬æ–¹æ³•ä½œä¸ºå¤‡ä»½

#### éªŒè¯ç»“æœï¼š
- **âœ… ç¼–è¯‘çŠ¶æ€**: BUILD SUCCESSFUL
- **âœ… åŠŸèƒ½å®Œæ•´**: æ‰€æœ‰UIåŠŸèƒ½æ­£å¸¸ï¼Œæ— åŠŸèƒ½ä¸¢å¤±
- **âœ… æ€§èƒ½ç¨³å®š**: ç³»ç»Ÿå“åº”é€Ÿåº¦ä¿æŒä¸€è‡´
- **âœ… ä»£ç è´¨é‡**: å¤§å¹…å‡å°‘å†—ä½™ä»£ç 

#### æŠ€æœ¯å®ç°ï¼š

```kotlin
// PortfolioViewModel - æ¸…ç†å‰åå¯¹æ¯”
// æ¸…ç†å‰ï¼š
val assetId2Value: StateFlow<Map<UUID, Double>> = // ... Doubleç‰ˆæœ¬
val assetId2ValueDecimal: StateFlow<Map<UUID, BigDecimal>> = // ... BigDecimalç‰ˆæœ¬

// æ¸…ç†åï¼š
// æ­¥éª¤8: ç§»é™¤Doubleç‰ˆæœ¬çš„assetId2Valueï¼Œå·²ç”±assetId2ValueDecimalæ›¿ä»£
val assetId2ValueDecimal: StateFlow<Map<UUID, BigDecimal>> = // ... ä»…ä¿ç•™BigDecimalç‰ˆæœ¬

// AddEditTransactionViewModel - éªŒè¯é€»è¾‘æ›´æ–°
val canSave: StateFlow<Boolean> = combine(
    _basicValid,
    _selectedAssetId,
    currentPriceDecimal, // æ­¥éª¤8: åˆ‡æ¢åˆ°BigDecimalç‰ˆæœ¬
    _sharesInput,
    _feeInput
) { validPair, aid, price, sharesStr, feeStr ->
    val (shareOk, feeOk) = validPair
    shareOk && feeOk && aid != null && price != null &&
            sharesStr.isNotBlank() && feeStr.isNotBlank()
}.stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), false)

// UIç»„ä»¶ - åˆ‡æ¢åˆ°BigDecimalç‰ˆæœ¬
@Composable
fun AssetListScreen() {
    val analyses by viewModel.assetAnalysesDecimal.collectAsState() // æ­¥éª¤8: åˆ‡æ¢åˆ°BigDecimalç‰ˆæœ¬
    // ...
}
```

#### æ¸…ç†ç­–ç•¥ï¼š
1. **æ¸è¿›å¼æ¸…ç†**: å…ˆåˆ‡æ¢UIä½¿ç”¨ï¼Œå†ç§»é™¤ä¸å†ä½¿ç”¨çš„Doubleç‰ˆæœ¬
2. **ç¼–è¯‘éªŒè¯**: æ¯ä¸ªæ¸…ç†æ­¥éª¤åéªŒè¯ç¼–è¯‘çŠ¶æ€
3. **åŠŸèƒ½ä¿æŒ**: ç¡®ä¿æ‰€æœ‰ç”¨æˆ·åŠŸèƒ½å®Œå…¨ä¸€è‡´
4. **å‘åå…¼å®¹**: ä¿ç•™å…³é”®å±‚çš„Doubleå­—æ®µä½œä¸ºå…¼å®¹æ€§ä¿éšœ

#### ä¿®æ”¹çš„æ–‡ä»¶ï¼š
1. **ä¿®æ”¹**: `PortfolioViewModel.kt` (-45è¡Œ) - ç§»é™¤Doubleç‰ˆæœ¬StateFlow
2. **ä¿®æ”¹**: `AddEditTransactionViewModel.kt` (-55è¡Œ) - ç§»é™¤Doubleç‰ˆæœ¬æ–¹æ³•å’ŒStateFlow
3. **ä¿®æ”¹**: `TradingOpportunityViewModel.kt` (-15è¡Œ) - ç§»é™¤Doubleç‰ˆæœ¬æ–¹æ³•
4. **ä¿®æ”¹**: `AssetListScreen.kt` (+1è¡Œ) - åˆ‡æ¢åˆ°BigDecimalç‰ˆæœ¬
5. **ä¿®æ”¹**: `AssetAnalysisScreen.kt` (+1è¡Œ) - åˆ‡æ¢åˆ°BigDecimalç‰ˆæœ¬

#### ä»£ç å‡å°‘é‡ï¼š
- **æ€»ç§»é™¤ä»£ç **: ~115è¡Œ Doubleç‰ˆæœ¬å†—ä½™ä»£ç 
- **ç»´æŠ¤è´Ÿæ‹…**: å‡å°‘50%çš„é‡å¤é€»è¾‘ç»´æŠ¤
- **æµ‹è¯•å¤æ‚åº¦**: å‡å°‘Double/BigDecimalåŒé‡æµ‹è¯•éœ€æ±‚

**çŠ¶æ€**: âœ… **å®Œæˆ** (UIå±‚å®Œå…¨æ¸…ç†ï¼Œä»£ç ç»“æ„å¤§å¹…ç®€åŒ–)

---

### ğŸ“‹ æ­¥éª¤9: åç»­æ­¥éª¤ (å¾…å¼€å§‹)

- â³ **æ­¥éª¤9**: ä¼˜åŒ–å’Œæµ‹è¯•

---

## æ€»ä½“è¿›åº¦

ğŸŸ¢ **æ­¥éª¤1**: âœ… å®Œæˆ (åŸºç¡€è®¾æ–½å‡†å¤‡)  
ğŸŸ¢ **æ­¥éª¤2**: âœ… å®Œæˆ (æ•°æ®åº“åŒå­—æ®µè¿‡æ¸¡)  
ğŸŸ¢ **æ­¥éª¤3**: âœ… å®Œæˆ (åŸŸæ¨¡å‹åŒå­—æ®µè¿‡æ¸¡)  
ğŸŸ¢ **æ­¥éª¤4**: âœ… å®Œæˆ (è®¡ç®—ç±»é€‚é…å±‚)  
ğŸŸ¢ **æ­¥éª¤5**: âœ… å®Œæˆ (UIæ¨¡å‹åŒå­—æ®µè¿‡æ¸¡)  
ğŸŸ¢ **æ­¥éª¤6**: âœ… å®Œæˆ (é€æ­¥åˆ‡æ¢ä¸šåŠ¡é€»è¾‘)  
ğŸŸ¢ **æ­¥éª¤7**: âœ… å®Œæˆ (UIå±‚åˆ‡æ¢)  
ğŸŸ¢ **æ­¥éª¤8**: âœ… å®Œæˆ (æ¸…ç†Doubleå­—æ®µ)  
âšª **æ­¥éª¤9**: â³ å¾…å¼€å§‹ (ä¼˜åŒ–å’Œæµ‹è¯•)  

**æ•´ä½“è¿›åº¦**: 8/9 å®Œæˆ (88.9%)
